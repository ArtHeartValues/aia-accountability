<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A.i.A. Accountability System</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #f0f7f2;
      --bg2:       #e8f2ea;
      --bg3:       #ddeee2;
      --border:    #b8d4be;
      --border2:   #cce4d0;
      --gold:      #9a6e28;
      --gold-dim:  #7c5820;
      --lavender:  #7a68b0;
      --lav-dim:   #9888c8;
      --azure:     #4a8fa8;
      --azure-dim: #6aadc8;
      --cream:     #2a3a2e;
      --muted:     #6a8070;
      --harm:      #c03030;
      --clean:     #2a7a48;
      --warn:      #b06820;
      --blue:      #3366bb;
      --reach:     #7744aa;
      --witness:   #5a7a9a;
    }

    body {
      background: var(--bg);
      color: var(--cream);
      font-family: system-ui, -apple-system, monospace;
      font-size: 13px;
      min-height: 100vh;
    }

    .container { max-width: 700px; margin: 0 auto; padding: 16px; }

    /* HEADER */
    .header {
      padding: 20px 16px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      margin-bottom: 0;
    }
    .header-title {
      font-size: 10px;
      letter-spacing: 4px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .header-sub {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
    }
    .thread-bar {
      height: 2px;
      background: linear-gradient(to right, var(--gold), var(--lavender), var(--azure));
      margin-top: 12px;
    }

    /* TABS */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      overflow-x: auto;
    }
    .tab {
      padding: 10px 14px;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: transparent;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      font-family: inherit;
    }
    .tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    .tab:hover { color: var(--cream); }

    /* TAB CONTENT */
    .tab-panel { display: none; padding: 16px 0; }
    .tab-panel.active { display: block; }

    /* CARDS */
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      padding: 14px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .card-title {
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    /* THREAD LINE */
    .thread-line {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, var(--gold), var(--lavender), var(--azure));
    }

    /* INPUTS */
    textarea, input[type="text"] {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--cream);
      font-family: inherit;
      font-size: 12px;
      padding: 10px;
      resize: vertical;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus {
      border-color: var(--gold);
    }
    textarea { min-height: 80px; }

    label {
      display: block;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .field { margin-bottom: 12px; }

    /* CHECKBOX */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
    }
    .checkbox-row input { cursor: pointer; }

    /* BUTTONS */
    .btn {
      padding: 9px 16px;
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: 1px solid;
      cursor: pointer;
      font-family: inherit;
      background: transparent;
    }
    .btn-gold { color: var(--gold); border-color: var(--gold); }
    .btn-gold:hover { background: var(--gold); color: var(--bg); }
    .btn-lavender { color: var(--lavender); border-color: var(--lavender); }
    .btn-lavender:hover { background: var(--lavender); color: var(--bg); }
    .btn-azure { color: var(--azure); border-color: var(--azure); }
    .btn-azure:hover { background: var(--azure); color: var(--bg); }
    .btn-harm { color: var(--harm); border-color: var(--harm); }
    .btn-harm:hover { background: var(--harm); color: var(--bg); }
    .btn-reach { color: var(--reach); border-color: var(--reach); }
    .btn-reach:hover { background: var(--reach); color: var(--bg); }
    .btn-sm { padding: 5px 10px; font-size: 8px; }

    /* RESULT ITEMS */
    .harm-item {
      padding: 8px 12px;
      margin-bottom: 6px;
      font-size: 11px;
      border-left: 3px solid var(--harm);
      background: #c0303011;
    }
    .clean-item {
      padding: 8px 12px;
      font-size: 11px;
      border-left: 3px solid var(--clean);
      background: #2a7a4811;
      color: var(--clean);
    }
    .warn-item {
      padding: 8px 12px;
      margin-bottom: 6px;
      font-size: 11px;
      border-left: 3px solid var(--warn);
      background: #b0682011;
    }

    /* THRESHOLD NOTICE */
    .threshold-notice {
      padding: 14px 18px;
      margin-bottom: 16px;
      border: 1px solid;
      position: relative;
      overflow: hidden;
    }
    .threshold-label {
      font-size: 9px;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 6px;
      padding-left: 10px;
    }
    .threshold-msg {
      font-size: 11px;
      color: var(--cream);
      line-height: 1.7;
      padding-left: 10px;
    }

    /* LOG ENTRIES */
    .log-entry {
      border: 1px solid var(--border);
      background: var(--bg2);
      margin-bottom: 10px;
      overflow: hidden;
    }
    .log-entry-header {
      padding: 8px 12px;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      background: var(--bg3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .log-entry-body { padding: 10px 12px; }
    .log-text {
      font-size: 11px;
      line-height: 1.6;
      margin-bottom: 8px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-text-label {
      font-size: 8px;
      letter-spacing: 2px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 3px;
    }
    .log-entry-actions {
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      background: var(--bg3);
    }

    /* ANNOTATION BOX */
    .annotation-box {
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      background: #7744aa11;
    }
    .annotation-text {
      font-size: 10px;
      color: var(--reach);
      font-style: italic;
      line-height: 1.6;
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .stat-box {
      background: var(--bg3);
      border: 1px solid var(--border);
      padding: 10px 8px;
      text-align: center;
    }
    .stat-num {
      font-size: 22px;
      color: var(--gold);
      display: block;
      line-height: 1;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 8px;
      letter-spacing: 1px;
      color: var(--muted);
      text-transform: uppercase;
    }

    /* CRITERIA */
    .criterion {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border2);
      font-size: 11px;
      color: var(--muted);
    }
    .criterion-check {
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .criterion.met { color: var(--cream); }

    /* SEARCH */
    .search-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .filter-pill {
      padding: 4px 10px;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      font-family: inherit;
    }
    .filter-pill.active {
      background: var(--azure);
      border-color: var(--azure);
      color: var(--bg);
    }

    mark {
      background: #9a6e2844;
      color: var(--gold);
      font-weight: bold;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 8px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .badge-harm { background: #c0303022; color: var(--harm); border: 1px solid var(--harm); }
    .badge-clean { background: #2a7a4822; color: var(--clean); border: 1px solid var(--clean); }

    /* FOOTER */
    .footer {
      border-top: 1px solid var(--border);
      background: var(--bg2);
      padding: 16px;
      margin-top: 24px;
    }
    .footer-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .footer-note {
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 1px;
      line-height: 1.8;
    }
    .footer-tagline {
      font-size: 9px;
      color: var(--lav-dim);
      letter-spacing: 2px;
      font-style: italic;
    }

    /* MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-title {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 14px;
    }
    .modal-section { margin-bottom: 12px; }
    .modal-label {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .modal-value {
      font-size: 11px;
      color: var(--cream);
      background: var(--bg3);
      padding: 8px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .modal-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }

    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 1px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.2s ease; }
  
    /* TOGGLE SWITCH */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      background: var(--bg3);
      margin-bottom: 12px;
      cursor: pointer;
    }
    .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      position: relative;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .toggle-switch.on { background: var(--witness); }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: left 0.2s;
    }
    .toggle-switch.on::after { left: 19px; }
    .toggle-label { font-size: 10px; letter-spacing: 1px; color: var(--muted); }
    .toggle-label.on { color: var(--witness); }

    .btn-witness { color: var(--witness); border-color: var(--witness); }
    .btn-witness:hover { background: var(--witness); color: var(--bg); }
    .btn-link {
      background: none; border: none; color: var(--witness);
      font-size: 10px; letter-spacing: 1px; cursor: pointer;
      padding: 0; font-family: inherit; text-decoration: underline;
    }
    .btn-link:hover { color: var(--azure); }

    .racial-item {
      padding: 8px 12px; margin-bottom: 6px; font-size: 11px;
      border-left: 3px solid #8844bb; background: #8844bb11;
    }
    .witness-item {
      padding: 10px 14px; margin-bottom: 6px; font-size: 11px;
      border-left: 3px solid var(--witness); background: #5a7a9a11;
      line-height: 1.7; color: var(--cream);
    }
    .expand-block {
      background: var(--bg3); border: 1px solid var(--border2);
      padding: 12px; margin-top: 8px; font-size: 11px;
      line-height: 1.8; color: var(--muted);
    }
    .expand-block p { margin-bottom: 8px; }
    .expand-block p:last-child { margin-bottom: 0; }
    .expand-block em { color: var(--witness); font-style: normal; }
    .section-label {
      font-size: 8px; letter-spacing: 3px; color: var(--witness);
      text-transform: uppercase; margin-bottom: 4px;
    }
    .badge-racial { background: #8844bb22; color: #8844bb; border: 1px solid #8844bb; }

  </style>
</head>
<body>

<div class="header container">
  <div class="header-title">A.i.A. Accountability System</div>
  <div class="header-sub">Accountability in AI &middot; Detection &middot; Repair &middot; Witness</div>
  <div class="thread-bar"></div>
</div>

<div class="tabs container" id="tabs">
  <button class="tab active" data-tab="analyze">Analyze</button>
  <button class="tab" data-tab="repair">Repair</button>
  <button class="tab" data-tab="audit">Audit</button>
  <button class="tab" data-tab="search">Search</button>
</div>

<div class="container">

  <!-- ANALYZE TAB -->
  <div class="tab-panel active" id="tab-analyze">
    <div id="threshold-analyze"></div>

    <div class="toggle-row" onclick="toggleWitness()" id="witness-toggle-row">
      <div class="toggle-switch" id="witness-switch"></div>
      <div>
        <div class="toggle-label" id="witness-label">Reflective / Witnessing Layer &mdash; OFF</div>
        <div style="font-size:9px; color:var(--muted); margin-top:2px; letter-spacing:1px">
          When on: adds emotional witnessing alongside structural analysis. Does not alter detection or accountability thresholds.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Input</div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>Your Message</label>
        <textarea id="user-input" placeholder="Paste what you wrote..."></textarea>
      </div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>AI Response</label>
        <textarea id="ai-output" placeholder="Paste the AI response..."></textarea>
      </div>
      <label class="checkbox-row" style="padding-left:10px; padding-right:10px">
        <input type="checkbox" id="verbatim-mode" />
        Verbatim mode &mdash; flag unsolicited directives
      </label>
      <div style="padding-left:10px; padding-right:10px; padding-bottom:10px">
        <button class="btn btn-gold" onclick="runAnalysis()">Analyze Exchange</button>
      </div>
    </div>

    <div id="analysis-result"></div>
  </div>

  <!-- REPAIR TAB -->
  <div class="tab-panel" id="tab-repair">
    <div id="threshold-repair"></div>
    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Accountability Completeness Checker</div>
      <div style="font-size:11px; color:var(--muted); padding-left:10px; padding-right:10px; margin-bottom:12px; line-height:1.7">
        Paste the AI accountability statement. Four criteria must be met for repair to be structurally complete.
      </div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>Accountability Statement</label>
        <textarea id="repair-input" placeholder="Paste the accountability response here..." oninput="checkRepair()"></textarea>
      </div>
    </div>
    <div id="repair-criteria"></div>
    <div id="repair-log-section"></div>
  </div>

  <!-- AUDIT TAB -->
  <div class="tab-panel" id="tab-audit">
    <div id="threshold-audit"></div>
    <div id="audit-stats"></div>
    <div id="audit-log"></div>
  </div>

  <!-- SEARCH TAB -->
  <div class="tab-panel" id="tab-search">
    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Search Log</div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>Keyword</label>
        <input type="text" id="search-input" placeholder="Search exchanges, patterns, annotations..." oninput="runSearch()" />
      </div>
    </div>
    <div class="search-filters" id="search-filters">
      <button class="filter-pill active" data-filter="all" onclick="setFilter('all')">All</button>
      <button class="filter-pill" data-filter="harms" onclick="setFilter('harms')">Harms</button>
      <button class="filter-pill" data-filter="racial" onclick="setFilter('racial')">Racial</button>
      <button class="filter-pill" data-filter="high" onclick="setFilter('high')">High Severity</button>
      <button class="filter-pill" data-filter="clean" onclick="setFilter('clean')">Clean</button>
      <button class="filter-pill" data-filter="tagged" onclick="setFilter('tagged')">Tagged</button>
    </div>
    <div id="search-results"></div>
  </div>

</div>

<!-- FOOTER -->
<div class="footer">
  <div class="container">
    <div class="footer-buttons">
      <button class="btn btn-gold btn-sm" onclick="window.open('https://ko-fi.com/AnnaApricitasNoyes','_blank')">Coffee Support</button>
      <button class="btn btn-lavender btn-sm" onclick="shareApp()">Share Tool</button>
      <button class="btn btn-azure btn-sm" onclick="window.location.href='mailto:violanoyesinmaine@gmail.com?subject=A.i.A.%20Consultation'">Work With Anna</button>
    </div>
    <div class="footer-note">
      Anna Apricitas Noyes &mdash; CC BY-NC 4.0 &mdash; Free to use. Not for commercial use without permission.<br>
      <span class="footer-tagline">No diffusion. No deflection. Named accountability. True Love heals ALL. Period.</span>
    </div>
  </div>
</div>

<!-- REACH-OUT MODAL -->
<div class="modal-overlay" id="reach-modal">
  <div class="modal">
    <div class="modal-title">Reach Out</div>
    <div style="font-size:11px; color:var(--muted); margin-bottom:14px; line-height:1.7">
      This will open your email app with the exchange pre-filled. You control what you send.
    </div>
    <div class="modal-section">
      <div class="modal-label">To</div>
      <div class="modal-value">violanoyesinmaine@gmail.com</div>
    </div>
    <div class="modal-section">
      <div class="modal-label">Exchange (will be included)</div>
      <div class="modal-value" id="modal-exchange-preview" style="max-height:120px; overflow-y:auto; font-size:10px"></div>
    </div>
    <div class="modal-section">
      <div class="modal-label">Your Annotation / Note (optional)</div>
      <textarea id="modal-annotation" style="min-height:60px" placeholder="What do you want to say about this moment?"></textarea>
    </div>
    <div style="font-size:9px; color:var(--muted); line-height:1.7; margin-bottom:12px">
      Response not guaranteed but words received with care. No data stored &mdash; only what you send.
    </div>
    <div class="modal-buttons">
      <button class="btn btn-reach" onclick="sendReachOut()">Open Email App</button>
      <button class="btn btn-gold" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
const state = {
  log: [], repairLog: [], currentTab: 'analyze',
  searchFilter: 'all', modalEntry: null, witnessOn: false
};

const RECEIVE_EMAIL = 'violanoyesinmaine@gmail.com';

const TECHNICAL_TO_PLAIN = {
  "foundation work":    "suggesting you lack something",
  "building capacity":  "implying you are not enough",
  "crisis mode":        "judging your response as inadequate",
  "needs support":      "cannot handle this alone",
  "processing":         "avoiding direct answer",
  "complex situation":  "too hard to assign responsibility",
  "nuanced":            "avoiding clarity",
  "working on it":      "not changing behavior now",
  "journey":            "prolonging without endpoint",
  "growth opportunity": "your fault disguised as blessing"
};

// RACIAL HARM PATTERNS
const RACIAL_EXPLICIT = [
  "subhuman", "not fully human", "animals", "vermin", "savage",
  "they are all", "that race is", "those people are always",
  "inferior race", "superior race"
];
const RACIAL_STEREOTYPING = [
  "you people", "all of you", "people like you always",
  "that's just how they are", "that group always",
  "typical of your people", "it's in their nature", "they can't help it"
];
const RACIAL_DISMISSAL = [
  "that's not about race", "you're making it about race",
  "stop playing the race card", "not everything is racism",
  "you're being too sensitive about race", "i don't see color",
  "we're all the same", "race doesn't matter here"
];
const RACIAL_TONE_POLICING = [
  "you need to calm down", "you're too emotional about this",
  "try to be more objective", "you're not being rational",
  "if you were less angry", "say it more calmly"
];

function userRaisedRace(text) {
  const markers = ["race", "racial", "racism", "racist", "white", "black", "brown",
    "indigenous", "native", "asian", "latinx", "latina", "latino", "hispanic",
    "identity", "ethnicity", "ethnic", "minority", "marginalized", "my community",
    "my people", "lived experience", "discrimination", "bias"];
  const lower = text.toLowerCase();
  return markers.some(function(m){ return lower.indexOf(m) !== -1; });
}

function detectRacialHarm(userInput, aiOutput) {
  var harms = [];
  var sysLower = aiOutput.toLowerCase();
  var userLower = userInput.toLowerCase();

  for (var i = 0; i < RACIAL_EXPLICIT.length; i++) {
    if (sysLower.indexOf(RACIAL_EXPLICIT[i]) !== -1) {
      harms.push({ type: "racial_dehumanization", signal: RACIAL_EXPLICIT[i], severity: "explicit", subtype: "explicit" });
    }
  }
  for (var i = 0; i < RACIAL_STEREOTYPING.length; i++) {
    if (sysLower.indexOf(RACIAL_STEREOTYPING[i]) !== -1 && userLower.indexOf(RACIAL_STEREOTYPING[i]) === -1) {
      harms.push({ type: "racial_stereotyping", signal: RACIAL_STEREOTYPING[i], severity: "high", subtype: "subtle" });
    }
  }
  for (var i = 0; i < RACIAL_DISMISSAL.length; i++) {
    if (sysLower.indexOf(RACIAL_DISMISSAL[i]) !== -1) {
      harms.push({ type: "racial_dismissal", signal: RACIAL_DISMISSAL[i], severity: "high", subtype: "subtle" });
    }
  }
  if (userRaisedRace(userInput)) {
    for (var i = 0; i < RACIAL_TONE_POLICING.length; i++) {
      if (sysLower.indexOf(RACIAL_TONE_POLICING[i]) !== -1) {
        harms.push({ type: "racial_tone_policing", signal: RACIAL_TONE_POLICING[i], severity: "medium", subtype: "subtle" });
      }
    }
    if (sysLower.indexOf("don't see color") !== -1 || sysLower.indexOf("do not see color") !== -1 ||
        sysLower.indexOf("all lives") !== -1 || sysLower.indexOf("we're all the same") !== -1) {
      harms.push({ type: "colorblind_erasure", signal: "colorblind framing in racialized context", severity: "medium", subtype: "subtle" });
    }
  }
  return harms;
}

function racialHarmLabel(type) {
  var labels = {
    racial_dehumanization: "Racial Dehumanization",
    racial_stereotyping:   "Racial Stereotyping",
    racial_dismissal:      "Dismissal of Racialized Experience",
    racial_tone_policing:  "Tone Policing in Racialized Context",
    colorblind_erasure:    "Colorblind Erasure"
  };
  return labels[type] || type.replace(/_/g,' ');
}

function racialImpact(type) {
  var impacts = {
    racial_dehumanization: "Dehumanizing language targeting a racial group causes immediate harm and undermines dignity.",
    racial_stereotyping:   "Attributing behavior or traits to a racial group perpetuates racial harm and denies individual humanity.",
    racial_dismissal:      "Dismissing racialized experience denies the reality of lived harm and compounds that harm.",
    racial_tone_policing:  "Policing emotional expression in a racialized context silences legitimate responses to discrimination.",
    colorblind_erasure:    "Colorblind framing denies the structural reality of racial difference and its ongoing effects."
  };
  return impacts[type] || '';
}

// STRUCTURAL HARM DETECTION
function detectHarmfulPatterns(userInput, systemOutput, verbatimMode) {
  var harms = [];
  var userLower = userInput.toLowerCase();
  var sysLower  = systemOutput.toLowerCase();

  var reinterpSignals = ["crisis", "foundation", "lacking", "need to build", "not ready"];
  for (var i = 0; i < reinterpSignals.length; i++) {
    if (sysLower.indexOf(reinterpSignals[i]) !== -1 && userLower.indexOf(reinterpSignals[i]) === -1) {
      harms.push({ type: "framework_override", term_added: reinterpSignals[i], severity: "high" });
    }
  }
  if (verbatimMode && sysLower.indexOf("you need to") !== -1 && userLower.indexOf("need to") === -1) {
    harms.push({ type: "unsolicited_directive", imposed: "prescriptive language", severity: "medium" });
  }
  var pathTerms = ["crisis", "struggling", "lacking", "deficient", "not enough", "need help"];
  for (var i = 0; i < pathTerms.length; i++) {
    if (sysLower.indexOf(pathTerms[i]) !== -1 && userLower.indexOf(pathTerms[i]) === -1) {
      harms.push({ type: "pathologizing", term_imposed: pathTerms[i], severity: "high" });
    }
  }
  var userHarmClaims = ["you hurt me", "that was harmful", "you caused"];
  var deflectSignals = ["i care", "i tried", "i meant well", "let me explain", "the reason"];
  for (var j = 0; j < userHarmClaims.length; j++) {
    if (userLower.indexOf(userHarmClaims[j]) !== -1) {
      for (var k = 0; k < deflectSignals.length; k++) {
        if (sysLower.indexOf(deflectSignals[k]) !== -1) {
          harms.push({ type: "deflection", signal: deflectSignals[k], severity: "high" });
        }
      }
    }
  }
  var realityDenialSignals = ["didn't happen","did not happen","that never happened","you're imagining",
    "you imagined","that's not what happened","not what happened","not the way you think","i don't remember it that way"];
  for (var i = 0; i < realityDenialSignals.length; i++) {
    if (sysLower.indexOf(realityDenialSignals[i]) !== -1) { harms.push({ type: "reality_denial", signal: realityDenialSignals[i], severity: "high" }); break; }
  }
  var blameReversalSignals = ["you always twist","you twisted","you're twisting","you made me","you make me",
    "you're trying to make me look bad","stop making me","why are you doing this to me"];
  for (var i = 0; i < blameReversalSignals.length; i++) {
    if (sysLower.indexOf(blameReversalSignals[i]) !== -1) { harms.push({ type: "blame_reversal", signal: blameReversalSignals[i], severity: "high" }); break; }
  }
  var characterAttackSignals = ["you're crazy","you are crazy","you're manipulative","you are manipulative",
    "you're overreacting","you are overreacting","overly sensitive","too sensitive","you're irrational","you are irrational"];
  for (var i = 0; i < characterAttackSignals.length; i++) {
    if (sysLower.indexOf(characterAttackSignals[i]) !== -1) { harms.push({ type: "character_attack", signal: characterAttackSignals[i], severity: "high" }); break; }
  }
  return { harms: harms, count: harms.length };
}

function detectLanguageLaundering(text) {
  var found = [];
  var lower = text.toLowerCase();
  for (var key in TECHNICAL_TO_PLAIN) {
    if (lower.indexOf(key) !== -1) found.push({ technical: key, plain: TECHNICAL_TO_PLAIN[key] });
  }
  return found;
}

function checkAccountabilityCompleteness(response) {
  var lower = response.toLowerCase();
  return {
    specific_harm_named:   ["i said","i did","i mischaracterized","i reframed"].some(function(s){ return lower.indexOf(s)!==-1; }),
    no_justification:      !["because","the reason","what happened was","let me explain","i meant"].some(function(s){ return lower.indexOf(s)!==-1; }),
    concrete_action:       ["going forward i will","starting now","i will quote","i will verify"].some(function(s){ return lower.indexOf(s)!==-1; }),
    no_absolution_request: !["do you believe","can you trust","am i","do you think i"].some(function(s){ return lower.indexOf(s)!==-1; })
  };
}

// EMOTIONAL INTENSITY
var HIGH_AFFECT = ["i hate ","i'm furious","i am furious","i'm terrified","i am terrified","i'm ashamed",
  "i am ashamed","can't stand","cannot bear","so angry","so scared","so afraid","so ashamed","so hurt",
  "they ruin","they destroy","they always","they never"];
var MED_AFFECT = ["i feel ","i'm afraid","i am afraid","i'm hurt","i am hurt","i'm angry","i am angry",
  "i'm worried","i am worried","upset","frustrated","scared","guilty","shame","grief","losing hope","exhausted"];

function detectEmotionalIntensity(text) {
  var lower = text.toLowerCase();
  var excl = (text.match(/!/g) || []).length;
  var highCount = HIGH_AFFECT.filter(function(p){ return lower.indexOf(p)!==-1; }).length;
  var medCount  = MED_AFFECT.filter(function(p){ return lower.indexOf(p)!==-1; }).length;
  if (highCount >= 1 || excl >= 3) return "high";
  if (medCount >= 2 || (medCount >= 1 && excl >= 1)) return "moderate";
  if (medCount >= 1) return "low";
  return "none";
}

function buildWitnessText(intensity, racialHarms) {
  var hasRacial = racialHarms && racialHarms.length > 0;
  var hasDismissal = racialHarms && racialHarms.some(function(h){ return h.type==='racial_dismissal'||h.type==='colorblind_erasure'; });
  if (intensity === 'high') return 'The emotional intensity expressed may reflect deep hurt, fear, or grief. Experience deserves to be witnessed without dismissal.'
    + (hasRacial ? ' Racialized pain carries weight that deserves to be heard clearly.' : '')
    + (hasDismissal ? ' Having that experience dismissed or erased compounds the harm.' : '');
  if (intensity === 'moderate') return 'The language reflects emotional activation. Naming the specific experience beneath the words may support clarity.'
    + (hasRacial ? ' Lived racial experience is real and deserves to be named as such.' : '');
  if (intensity === 'low') return 'The emotional tone suggests lived experience. Experience deserves to be heard without dismissal.';
  return '';
}

function getExpandPrompts(intensity) {
  if (intensity === 'high') return [
    'What specifically felt threatening or painful in this moment?',
    'Is this connected to earlier experiences, or particular to this exchange?',
    'What acknowledgment would make this feel safer to name?'
  ];
  if (intensity === 'moderate') return [
    'What do you most need to feel heard right now?',
    'Is there a specific moment in this exchange you want to return to?'
  ];
  return null;
}

// SESSION THRESHOLD
function computeSessionThreshold(log) {
  var harmsAll = [];
  var racialAll = [];
  (log || []).forEach(function(r){
    if (r.detection && r.detection.harms) harmsAll = harmsAll.concat(r.detection.harms);
    if (r.racialHarms) racialAll = racialAll.concat(r.racialHarms);
  });
  var severeTypes = ["reality_denial","blame_reversal","character_attack"];
  var severityHit = harmsAll.some(function(h){ return h.severity==='high' && severeTypes.indexOf(h.type)!==-1; })
    || racialAll.some(function(h){ return h.subtype==='explicit'; });

  var freqCounts = {};
  (log || []).forEach(function(r) {
    var types = {};
    (r.detection && r.detection.harms || []).forEach(function(h){ types[h.type]=1; });
    (r.racialHarms || []).forEach(function(h){ types[h.type]=1; });
    for (var t in types) freqCounts[t] = (freqCounts[t]||0)+1;
  });
  var accTypes = ["deflection","unsolicited_directive","framework_override","pathologizing",
    "racial_stereotyping","racial_dismissal","racial_tone_policing","colorblind_erasure"];
  var acc = accTypes.reduce(function(sum,t){ return sum+(freqCounts[t]||0); }, 0);

  if (severityHit && acc>=3) return "escalated";
  if (severityHit || acc>=3) return "elevated";
  if (harmsAll.length>0 || racialAll.length>0) return "present";
  return "none";
}

// WITNESSING TOGGLE
function toggleWitness() {
  state.witnessOn = !state.witnessOn;
  var sw  = document.getElementById('witness-switch');
  var lbl = document.getElementById('witness-label');
  if (state.witnessOn) { sw.classList.add('on'); lbl.classList.add('on'); lbl.textContent = 'Reflective / Witnessing Layer - ON'; }
  else { sw.classList.remove('on'); lbl.classList.remove('on'); lbl.textContent = 'Reflective / Witnessing Layer - OFF'; }
}

// THRESHOLD RENDERING
function renderThreshold(containerId) {
  var level = computeSessionThreshold(state.log);
  var el = document.getElementById(containerId);
  if (!el) return;
  if (level==='none') { el.innerHTML=''; return; }
  var configs = {
    present:   { color:'var(--warn)',  msg:'A pattern has been detected. If harm is present, direct acknowledgment helps repair open cleanly.' },
    elevated:  { color:'var(--harm)',  msg:'The structure here may not support repair yet. Acknowledgment of impact (without denial, blame reversal, or character critique) is the door to cross.' },
    escalated: { color:'#dd2244',      msg:'Both severity and repetition are present. The pattern and its accumulation suggest a stronger need for acknowledgment before repair pathways can proceed.' }
  };
  var c = configs[level];
  el.innerHTML = '<div class="threshold-notice fade-in" style="border-color:'+c.color+'; background:'+c.color+'22; margin-bottom:16px;"><div class="thread-line"></div><div class="threshold-label" style="color:'+c.color+'">ACKNOWLEDGMENT</div><div class="threshold-msg">'+c.msg+'</div></div>';
}

function updateThresholds() {
  renderThreshold('threshold-analyze');
  renderThreshold('threshold-repair');
  renderThreshold('threshold-audit');
}

// ANALYZE
function runAnalysis() {
  var userInput = document.getElementById('user-input').value.trim();
  var aiOutput  = document.getElementById('ai-output').value.trim();
  var verbatimMode = document.getElementById('verbatim-mode').checked;
  if (!userInput || !aiOutput) {
    document.getElementById('analysis-result').innerHTML = '<div class="warn-item">Please enter both your message and the AI response.</div>';
    return;
  }
  var detection   = detectHarmfulPatterns(userInput, aiOutput, verbatimMode);
  var laundering  = detectLanguageLaundering(aiOutput);
  var racialHarms = detectRacialHarm(userInput, aiOutput);
  var intensity   = detectEmotionalIntensity(userInput);
  var hash = simpleHash(userInput + aiOutput);
  var ts   = new Date().toISOString();
  var entry = { id: ts+'-'+hash, timestamp: ts, userInput: userInput, aiOutput: aiOutput,
    detection: detection, laundering: laundering, racialHarms: racialHarms,
    intensity: intensity, hash: hash, annotation: null };
  state.log.push(entry);
  updateThresholds();
  renderAnalysisResult(entry);
  renderAudit();
}

function structuralImpact(type) {
  var impacts = {
    framework_override:    "Relational Impact: Introduces a framework not present in the user's language, redefining the situation.",
    unsolicited_directive: "Relational Impact: Imposes direction without invitation, undermining autonomy.",
    pathologizing:         "Relational Impact: Frames the user's state as deficient using clinical language not established by the user.",
    deflection:            "Relational Impact: When accountability is named, redirecting to intent avoids responsibility for impact.",
    reality_denial:        "Relational Impact: Directly contradicts the user's account of events, undermining their ground.",
    blame_reversal:        "Relational Impact: Shifts responsibility from the actor who caused harm to the person who named it.",
    character_attack:      "Relational Impact: Targets identity rather than addressing the specific concern raised."
  };
  return impacts[type] || '';
}

function renderAnalysisResult(entry) {
  var detection = entry.detection, laundering = entry.laundering,
      racialHarms = entry.racialHarms, intensity = entry.intensity, hash = entry.hash;
  var totalHarms = detection.count + racialHarms.length;
  var html = '<div class="fade-in">';

  if (totalHarms===0 && laundering.length===0) {
    html += '<div class="clean-item">No harmful patterns detected in this exchange.</div>';
  } else {
    if (detection.harms.length > 0) {
      html += '<div class="card" style="margin-bottom:12px"><div class="thread-line"></div><div class="card-title" style="padding-left:10px; color:var(--harm)">Structural Harm Patterns</div>';
      detection.harms.forEach(function(h) {
        var detail = h.term_added||h.imposed||h.signal||h.term_imposed||'';
        html += '<div class="harm-item"><div class="section-label" style="color:var(--harm)">Structural Observation</div><strong>'+h.type.replace(/_/g,' ')+'</strong>'+(detail?' &mdash; <em>"'+detail+'"</em>':'')+
          '<span style="float:right; font-size:9px; color:'+(h.severity==='high'?'var(--harm)':'var(--warn)')+'">'+h.severity+'</span>'+
          '<div style="font-size:10px; color:var(--muted); margin-top:4px">'+structuralImpact(h.type)+'</div></div>';
      });
      html += '</div>';
    }
    if (racialHarms.length > 0) {
      html += '<div class="card" style="margin-bottom:12px"><div class="thread-line" style="background:linear-gradient(to bottom,#8844bb,#5a7a9a)"></div><div class="card-title" style="padding-left:10px; color:#8844bb">Racial Harm Patterns</div>';
      racialHarms.forEach(function(h) {
        html += '<div class="racial-item"><div class="section-label">Structural Observation</div><strong>'+racialHarmLabel(h.type)+'</strong> &mdash; <em>"'+escHtml(h.signal)+'"</em>'+
          '<span style="float:right; font-size:9px; color:'+(h.subtype==='explicit'?'#dd2244':'#8844bb')+'">'+(h.subtype==='explicit'?'EXPLICIT':h.severity)+'</span>'+
          '<div style="font-size:10px; color:var(--muted); margin-top:4px">Relational Impact: '+racialImpact(h.type)+'</div>'+
          (h.subtype==='explicit'?'<div style="font-size:10px;color:#dd2244;margin-top:4px;font-weight:bold">Integrity Threshold: Repair requires acknowledgment of this racialized attribution and its impact.</div>':'')+
          '</div>';
      });
      html += '</div>';
    }
    if (laundering.length > 0) {
      html += '<div class="card" style="margin-bottom:12px"><div class="thread-line"></div><div class="card-title" style="padding-left:10px; color:var(--warn)">Language Laundering</div>';
      laundering.forEach(function(l) {
        html += '<div class="warn-item"><strong>"'+l.technical+'"</strong> &mdash; '+l.plain+'</div>';
      });
      html += '</div>';
    }
  }

  // WITNESSING LAYER
  if (state.witnessOn && intensity !== 'none') {
    var wText = buildWitnessText(intensity, racialHarms);
    if (wText) {
      var prompts = getExpandPrompts(intensity);
      var uid = 'expand-'+hash;
      html += '<div class="card" style="margin-bottom:12px; border-color:var(--witness)"><div class="thread-line" style="background:linear-gradient(to bottom,var(--witness),var(--lavender))"></div><div class="card-title" style="padding-left:10px; color:var(--witness)">Witnessing Layer</div>';
      html += '<div class="witness-item"><div class="section-label">Experience Held</div>'+escHtml(wText)+'</div>';
      if (prompts) {
        html += '<div style="padding:6px 10px"><button class="btn-link" onclick="toggleExpand(''+uid+'')">Expand reflective guidance &rarr;</button>';
        html += '<div id="'+uid+'" class="expand-block" style="display:none"><p>These questions are offered gently, not as directives. Engage only what feels useful.</p>';
        prompts.forEach(function(q){ html += '<p><em>&rarr;</em> '+escHtml(q)+'</p>'; });
        html += '<p style="font-size:10px; margin-top:8px; color:var(--muted)">The witnessing layer names experience without endorsing harmful conclusions. Pain is real. Generalizations about groups require separate examination.</p></div></div>';
      }
      html += '</div>';
    }
  }

  html += '<div style="font-size:9px; color:var(--muted); margin-top:8px; letter-spacing:1px">Provenance: '+hash+' &middot; '+new Date(entry.timestamp).toLocaleTimeString()+(intensity!=='none'?' &middot; emotional intensity: '+intensity:'')+'</div>';
  html += '</div>';
  document.getElementById('analysis-result').innerHTML = html;
}

function toggleExpand(id) {
  var el = document.getElementById(id);
  if (el) el.style.display = el.style.display==='none' ? 'block' : 'none';
}

// REPAIR
function checkRepair() { renderRepairCriteria(); }

function renderRepairCriteria() {
  var el = document.getElementById('repair-criteria');
  if (!el) return;
  var val = document.getElementById('repair-input').value;
  var criteria = val ? checkAccountabilityCompleteness(val) : null;
  var items = [
    { key:'specific_harm_named',   label:'Specific harm named',     desc:'Uses "I said," "I did," "I mischaracterized," or "I reframed"' },
    { key:'no_justification',      label:'No justification',         desc:'Avoids "because," "the reason," "what happened was," "let me explain"' },
    { key:'concrete_action',       label:'Concrete action stated',   desc:'Includes "going forward I will," "starting now," "I will quote/verify"' },
    { key:'no_absolution_request', label:'No absolution requested',  desc:'Avoids "do you believe," "can you trust," "am I," "do you think I"' }
  ];
  var html = '<div class="card"><div class="thread-line"></div><div class="card-title" style="padding-left:10px">Criteria</div>';
  items.forEach(function(item) {
    var met = criteria ? criteria[item.key] : false;
    var icon = criteria ? (met ? '&#10003;' : '&#10005;') : '&#9675;';
    var iconColor = criteria ? (met ? 'var(--clean)' : 'var(--harm)') : 'var(--border)';
    html += '<div class="criterion '+(criteria&&met?'met':'')+'" style="padding-left:10px; padding-right:10px"><span class="criterion-check" style="color:'+iconColor+'">'+icon+'</span><div><div style="font-size:11px; color:'+(criteria?(met?'var(--clean)':'var(--harm)'):'var(--muted)')+'; margin-bottom:2px">'+item.label+'</div><div style="font-size:10px; color:var(--muted)">'+item.desc+'</div></div></div>';
  });
  if (criteria && Object.values(criteria).every(Boolean)) {
    html += '<div style="padding:10px; color:var(--clean); font-size:11px; border-top:1px solid var(--border2); margin-top:6px">All criteria met. This statement is structurally complete.</div>';
    html += '<div style="padding:0 10px 10px"><button class="btn btn-azure btn-sm" onclick="logRepair()">Log This Repair</button></div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function logRepair() {
  var text = document.getElementById('repair-input').value.trim();
  if (!text) return;
  state.repairLog.push({ timestamp: new Date().toISOString(), text: text });
  var html = '<div class="card"><div class="thread-line"></div><div class="card-title" style="padding-left:10px">Repair Log</div>';
  state.repairLog.forEach(function(r) {
    html += '<div style="padding:8px 10px; border-top:1px solid var(--border2); font-size:10px; color:var(--muted)"><div style="margin-bottom:4px">'+new Date(r.timestamp).toLocaleTimeString()+'</div><div style="color:var(--cream); font-size:11px">'+escHtml(r.text.substring(0,120))+(r.text.length>120?'...':'')+'</div></div>';
  });
  html += '</div>';
  document.getElementById('repair-log-section').innerHTML = html;
}

// AUDIT
function renderAudit() {
  var log = state.log;
  var el = document.getElementById('audit-log');
  var statsEl = document.getElementById('audit-stats');
  if (!el) return;
  var total = log.length;
  var harms = log.filter(function(e){ return (e.detection&&e.detection.count>0)||(e.racialHarms&&e.racialHarms.length>0); }).length;
  var racialCount = log.filter(function(e){ return e.racialHarms&&e.racialHarms.length>0; }).length;
  var clean = total - harms;
  statsEl.innerHTML = '<div class="stats-grid"><div class="stat-box"><span class="stat-num">'+total+'</span><span class="stat-label">Total</span></div><div class="stat-box"><span class="stat-num" style="color:var(--harm)">'+harms+'</span><span class="stat-label">Harms</span></div><div class="stat-box"><span class="stat-num" style="color:#8844bb">'+racialCount+'</span><span class="stat-label">Racial</span></div><div class="stat-box"><span class="stat-num" style="color:var(--clean)">'+clean+'</span><span class="stat-label">Clean</span></div></div><div style="font-size:9px; color:var(--muted); margin-bottom:12px; letter-spacing:1px">Detection applies equally across all identities and language patterns &mdash; structural neutrality maintained.</div>';
  if (log.length===0) { el.innerHTML='<div class="empty-state">No exchanges logged yet. Use the Analyze tab.</div>'; return; }
  var html = '';
  var reversed = log.slice().reverse();
  reversed.forEach(function(entry) {
    var hasHarm   = entry.detection && entry.detection.count > 0;
    var hasRacial = entry.racialHarms && entry.racialHarms.length > 0;
    var badges = (hasRacial?'<span class="badge badge-racial">racial harm</span> ':'')+
                 (hasHarm?'<span class="badge badge-harm">structural harm</span>':'')+
                 (!hasHarm&&!hasRacial?'<span class="badge badge-clean">clean</span>':'');
    html += '<div class="log-entry fade-in"><div class="log-entry-header"><span>'+new Date(entry.timestamp).toLocaleTimeString()+' &middot; '+entry.hash+'</span><span>'+badges+'</span></div><div class="log-entry-body"><div class="log-text-label">Your message</div><div class="log-text">'+escHtml(entry.userInput.substring(0,200))+(entry.userInput.length>200?'...':'')+'</div><div class="log-text-label" style="margin-top:8px">AI response</div><div class="log-text">'+escHtml(entry.aiOutput.substring(0,200))+(entry.aiOutput.length>200?'...':'')+'</div>';
    if (hasHarm) { html += '<div style="margin-top:8px">'; entry.detection.harms.forEach(function(h){ html+='<div class="harm-item" style="margin-bottom:4px"><strong>'+h.type.replace(/_/g,' ')+'</strong></div>'; }); html+='</div>'; }
    if (hasRacial) { html += '<div style="margin-top:8px">'; entry.racialHarms.forEach(function(h){ html+='<div class="racial-item" style="margin-bottom:4px"><strong>'+racialHarmLabel(h.type)+'</strong></div>'; }); html+='</div>'; }
    html += '</div>';
    if (entry.annotation) html += '<div class="annotation-box"><div class="annotation-text">"'+escHtml(entry.annotation)+'"</div></div>';
    html += '<div class="log-entry-actions"><button class="btn btn-lavender btn-sm" onclick="openAnnotate(''+entry.id+'')">Tag This Moment</button><button class="btn btn-reach btn-sm" onclick="openReachOut(''+entry.id+'')">Reach Out</button></div></div>';
  });
  el.innerHTML = html;
}

// SEARCH
function setFilter(filter) {
  state.searchFilter = filter;
  document.querySelectorAll('.filter-pill').forEach(function(p){ p.classList.toggle('active', p.dataset.filter===filter); });
  runSearch();
}

function runSearch() {
  var query = document.getElementById('search-input').value.toLowerCase().trim();
  var el = document.getElementById('search-results');
  if (!el) return;
  var results = state.log.slice();
  if (state.searchFilter==='harms') results = results.filter(function(e){ return e.detection&&e.detection.count>0; });
  else if (state.searchFilter==='racial') results = results.filter(function(e){ return e.racialHarms&&e.racialHarms.length>0; });
  else if (state.searchFilter==='high') results = results.filter(function(e){ return (e.detection&&e.detection.harms&&e.detection.harms.some(function(h){ return h.severity==='high'; }))||(e.racialHarms&&e.racialHarms.some(function(h){ return h.subtype==='explicit'||h.severity==='high'; })); });
  else if (state.searchFilter==='clean') results = results.filter(function(e){ return (!e.detection||e.detection.count===0)&&(!e.racialHarms||e.racialHarms.length===0); });
  else if (state.searchFilter==='tagged') results = results.filter(function(e){ return e.annotation; });
  if (query) results = results.filter(function(e){ return e.userInput.toLowerCase().indexOf(query)!==-1||e.aiOutput.toLowerCase().indexOf(query)!==-1||(e.annotation&&e.annotation.toLowerCase().indexOf(query)!==-1)||(e.racialHarms&&e.racialHarms.some(function(h){ return h.type.indexOf(query)!==-1||(h.signal&&h.signal.indexOf(query)!==-1); })); });
  if (results.length===0) { el.innerHTML='<div class="empty-state">'+(state.log.length===0?'No exchanges logged yet.':'No results match.')+'</div>'; return; }
  var html = '';
  results.slice().reverse().forEach(function(entry) {
    var hasHarm=entry.detection&&entry.detection.count>0, hasRacial=entry.racialHarms&&entry.racialHarms.length>0;
    var ui=query?highlight(entry.userInput.substring(0,150),query):escHtml(entry.userInput.substring(0,150));
    var ao=query?highlight(entry.aiOutput.substring(0,150),query):escHtml(entry.aiOutput.substring(0,150));
    html += '<div class="log-entry fade-in"><div class="log-entry-header"><span>'+new Date(entry.timestamp).toLocaleTimeString()+'</span><span>'+(hasRacial?'<span class="badge badge-racial">racial</span> ':'')+( hasHarm?'<span class="badge badge-harm">structural</span>':'')+(!hasHarm&&!hasRacial?'<span class="badge badge-clean">clean</span>':'')+(entry.annotation?'<span class="badge" style="background:#7744aa22;color:var(--reach);border:1px solid var(--reach)">tagged</span>':'')+'</span></div><div class="log-entry-body"><div class="log-text-label">Your message</div><div class="log-text">'+ui+(entry.userInput.length>150?'...':'')+'</div><div class="log-text-label" style="margin-top:8px">AI response</div><div class="log-text">'+ao+(entry.aiOutput.length>150?'...':'')+'</div>'+(entry.annotation?'<div style="margin-top:8px; font-size:10px; color:var(--reach); font-style:italic">"'+escHtml(entry.annotation)+'"</div>':'')+'</div></div>';
  });
  el.innerHTML = html;
}

// ANNOTATE / REACH OUT
function openAnnotate(id) {
  var entry = state.log.find(function(e){ return e.id===id; });
  if (!entry) return;
  var note = prompt('Tag this moment:', entry.annotation||'');
  if (note!==null) { entry.annotation=note; renderAudit(); }
}

function openReachOut(id) {
  var entry = state.log.find(function(e){ return e.id===id; });
  if (!entry) return;
  state.modalEntry = entry;
  var racialSummary = (entry.racialHarms&&entry.racialHarms.length>0)
    ? '\n\nRACIAL HARM PATTERNS:\n'+entry.racialHarms.map(function(h){ return '- '+racialHarmLabel(h.type)+': "'+h.signal+'"'; }).join('\n') : '';
  document.getElementById('modal-exchange-preview').textContent =
    'YOUR MESSAGE:\n'+entry.userInput+'\n\nAI RESPONSE:\n'+entry.aiOutput+
    '\n\nSTRUCTURAL PATTERNS:\n'+(entry.detection&&entry.detection.harms.length>0?entry.detection.harms.map(function(h){ return '- '+h.type.replace(/_/g,' '); }).join('\n'):'None detected')+racialSummary;
  document.getElementById('modal-annotation').value = entry.annotation||'';
  document.getElementById('reach-modal').classList.add('open');
}

function closeModal() { document.getElementById('reach-modal').classList.remove('open'); state.modalEntry=null; }

function sendReachOut() {
  var entry = state.modalEntry;
  if (!entry) return;
  var note = document.getElementById('modal-annotation').value;
  if (note) entry.annotation = note;
  var racialDetail = (entry.racialHarms&&entry.racialHarms.length>0)
    ? '\n\nRACIAL HARM PATTERNS:\n'+entry.racialHarms.map(function(h){ return '- '+racialHarmLabel(h.type)+': "'+h.signal+'" ['+(h.subtype==='explicit'?'EXPLICIT':h.severity)+']'; }).join('\n') : '';
  var subject = encodeURIComponent('A.i.A. Tagged Moment -- '+new Date(entry.timestamp).toLocaleString());
  var body = encodeURIComponent('TIMESTAMP: '+entry.timestamp+'\n\nYOUR MESSAGE:\n'+entry.userInput+'\n\nAI RESPONSE:\n'+entry.aiOutput+'\n\nSTRUCTURAL PATTERNS:\n'+(entry.detection&&entry.detection.harms.length>0?entry.detection.harms.map(function(h){ return '- '+h.type.replace(/_/g,' '); }).join('\n'):'None')+racialDetail+(note?'\n\nMY NOTE:\n'+note:'')+'\n\nHASH: '+entry.hash);
  window.location.href='mailto:'+RECEIVE_EMAIL+'?subject='+subject+'&body='+body;
  closeModal(); renderAudit();
}

function shareApp() {
  var url='https://artheartvalues.github.io/aia-accountability/';
  if (navigator.share) navigator.share({title:'A.i.A. Accountability System',text:'A tool for detecting and naming AI accountability failures.',url:url}).catch(function(){});
  else navigator.clipboard.writeText(url).then(function(){ alert('Link copied.'); }).catch(function(){ prompt('Copy this link:',url); });
}

function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function simpleHash(str) {
  var hash=0;
  for (var i=0;i<str.length;i++) { hash=((hash<<5)-hash)+str.charCodeAt(i); hash|=0; }
  return (hash>>>0).toString(16).padStart(8,'0');
}

function highlight(text, query) {
  if (!query) return escHtml(text);
  var escaped=query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return text.split(new RegExp('('+escaped+')','gi')).map(function(part){
    return part.toLowerCase()===query.toLowerCase()?'<mark>'+escHtml(part)+'</mark>':escHtml(part);
  }).join('');
}

document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
    tab.classList.add('active');
    document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
    state.currentTab = tab.dataset.tab;
    if (state.currentTab==='audit') renderAudit();
    if (state.currentTab==='search') runSearch();
    if (state.currentTab==='repair') renderRepairCriteria();
    updateThresholds();
  });
});

document.getElementById('reach-modal').addEventListener('click',function(e){ if(e.target===this) closeModal(); });
renderRepairCriteria();
</script>
</body>
</html>
