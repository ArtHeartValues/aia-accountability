<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>A.i.A. Accountability System</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #f0f7f2;
      --bg2:       #e8f2ea;
      --bg3:       #ddeee2;
      --border:    #b8d4be;
      --border2:   #cce4d0;
      --gold:      #9a6e28;
      --gold-dim:  #7c5820;
      --lavender:  #7a68b0;
      --lav-dim:   #9888c8;
      --azure:     #4a8fa8;
      --azure-dim: #6aadc8;
      --cream:     #2a3a2e;
      --muted:     #6a8070;
      --harm:      #c03030;
      --clean:     #2a7a48;
      --warn:      #b06820;
      --blue:      #3366bb;
      --reach:     #7744aa;
      --witness:   #5a7a9a;
    }


    /* === WELCOME SCREEN === */
    #welcome-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      background: var(--bg);
    }
    .welcome-inner {
      max-width: 560px;
      width: 100%;
      text-align: center;
    }
    .welcome-mark {
      font-size: 13px;
      letter-spacing: 6px;
      color: var(--gold);
      margin-bottom: 24px;
      font-weight: 600;
    }
    .welcome-title {
      font-size: clamp(22px, 5vw, 32px);
      font-weight: 700;
      color: var(--cream);
      line-height: 1.3;
      margin-bottom: 20px;
      letter-spacing: -0.3px;
    }
    .welcome-body {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.85;
      max-width: 440px;
      margin: 0 auto;
    }
    .welcome-paths {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 32px 0 20px;
    }
    @media (max-width: 480px) { .welcome-paths { grid-template-columns: 1fr; } }
    .path-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 20px 16px;
      cursor: pointer;
      text-align: left;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .path-card:hover {
      border-color: var(--gold);
      box-shadow: 0 2px 12px rgba(154,110,40,0.12);
    }
    .path-icon {
      font-size: 20px;
      color: var(--gold);
      margin-bottom: 10px;
    }
    .path-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 6px;
      letter-spacing: 0.3px;
    }
    .path-desc {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.7;
      margin-bottom: 10px;
    }
    .path-action {
      font-size: 11px;
      color: var(--gold);
      font-weight: 600;
    }
    .welcome-skip {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      padding: 8px;
      opacity: 0.7;
    }
    .welcome-skip:hover { opacity: 1; }

    /* === BACK BUTTON === */
    .back-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: 3px;
      letter-spacing: 0.5px;
    }
    .back-btn:hover { border-color: var(--gold); color: var(--gold); }

    /* === GROUNDING MOMENT === */
    #grounding-moment {
      padding: 8px 0 0;
    }
    .grounding-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-left: 4px solid var(--lavender);
      padding: 24px 20px;
      margin-bottom: 16px;
      border-radius: 0 4px 4px 0;
    }
    .grounding-text {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .grounding-question {
      font-size: 18px;
      font-weight: 600;
      color: var(--cream);
      line-height: 1.4;
      margin-bottom: 8px;
    }
    .grounding-note {
      font-size: 11px;
      color: var(--muted);
      font-style: italic;
      line-height: 1.6;
    }

    /* === LEARN TAB === */
    .learn-intro { margin-bottom: 12px; }
    .learn-section { margin-bottom: 8px; }
    .learn-section-title {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--muted);
      text-transform: uppercase;
      padding: 0 0 8px;
      border-bottom: 1px solid var(--border2);
      margin-bottom: 8px;
    }
    .learn-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 8px;
      cursor: pointer;
      overflow: hidden;
      transition: border-color 0.15s;
    }
    .learn-card:hover { border-color: var(--gold-dim); }
    .learn-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
    }
    .learn-icon { font-size: 14px; flex-shrink: 0; }
    .learn-card-name {
      flex: 1;
      font-size: 12px;
      font-weight: 600;
      color: var(--cream);
    }
    .learn-toggle {
      font-size: 12px;
      color: var(--muted);
      transition: transform 0.2s;
    }
    .learn-card-body {
      padding: 0 14px 14px;
      border-top: 1px solid var(--border2);
    }
    .learn-card-body p {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.8;
      margin-top: 10px;
    }
    .learn-card-body strong { color: var(--cream); }
    .learn-quote {
      margin-top: 12px;
      padding: 10px 12px;
      border-left: 3px solid var(--lavender);
      background: var(--bg3);
      font-size: 10px;
      color: var(--muted);
      font-style: italic;
      line-height: 1.7;
      border-radius: 0 3px 3px 0;
    }

    body {
      background: var(--bg);
      color: var(--cream);
      font-family: system-ui, -apple-system, monospace;
      font-size: 13px;
      min-height: 100vh;
    }

    /* === LAYOUT WITH SIDEBAR === */
    .page-wrap {
      display: flex;
      align-items: flex-start;
      max-width: 1080px;
      margin: 0 auto;
    }
    .main-col { flex: 1; min-width: 0; }
    .container { max-width: 700px; margin: 0 auto; padding: 16px; }

    /* === SESSION MEMORY SIDEBAR === */
    .session-sidebar {
      width: 196px;
      flex-shrink: 0;
      position: sticky;
      top: 16px;
      margin-left: 18px;
      margin-top: 16px;
      font-size: 10px;
    }
    .sm-title {
      font-size: 8px; letter-spacing: 3px; color: var(--gold);
      text-transform: uppercase; margin-bottom: 10px;
      padding-bottom: 6px; border-bottom: 1px solid var(--border);
    }
    .sm-section { margin-bottom: 12px; }
    .sm-section-label {
      font-size: 8px; letter-spacing: 2px; color: var(--muted);
      text-transform: uppercase; margin-bottom: 5px;
    }
    .sm-stat {
      display: flex; justify-content: space-between; align-items: center;
      padding: 3px 0; border-bottom: 1px solid var(--border2);
    }
    .sm-stat:last-child { border-bottom: none; }
    .sm-stat-label { color: var(--cream); font-size: 9px; line-height: 1.4; }
    .sm-stat-val { font-size: 11px; font-weight: bold; min-width: 20px; text-align: right; }
    .sm-stat-val.zero { color: var(--muted); }
    .sm-stat-val.low  { color: var(--clean); }
    .sm-stat-val.mid  { color: var(--gold); }
    .sm-stat-val.high { color: var(--harm); }
    .sm-threshold-pill {
      display: inline-block; padding: 3px 9px;
      font-size: 8px; letter-spacing: 1px; text-transform: uppercase; margin-top: 4px;
    }
    .sm-threshold-pill.none     { background: var(--bg3); color: var(--muted); }
    .sm-threshold-pill.present  { background: #2a3a1a; color: var(--clean); border: 1px solid var(--clean); }
    .sm-threshold-pill.elevated { background: #3a2a00; color: var(--gold);  border: 1px solid var(--gold); }
    .sm-threshold-pill.escalated{ background: #3a1010; color: var(--harm);  border: 1px solid var(--harm); }
    .sm-bar-wrap { height: 3px; background: var(--border); margin: 4px 0 8px; }
    .sm-bar { height: 3px; background: var(--lavender); transition: width 0.4s; }
    .sm-pattern-row {
      display: flex; justify-content: space-between;
      padding: 2px 0; font-size: 9px; color: var(--muted);
    }
    .sm-pattern-row.active { color: var(--cream); }
    .sm-pattern-count { font-weight: bold; color: var(--gold); }
    .sm-footer-note {
      font-size: 8px; color: var(--muted); line-height: 1.5;
      margin-top: 10px; padding-top: 8px; border-top: 1px solid var(--border2);
    }
    .sm-severity-dot {
      display: inline-block; width: 7px; height: 7px;
      border-radius: 50%; margin-right: 5px; vertical-align: middle;
    }
    @media (max-width: 900px) {
      .session-sidebar { display: none; }
      .page-wrap { display: block; }
      .mobile-memory-btn {
        display: flex;
        position: fixed;
        bottom: 16px;
        right: 16px;
        z-index: 200;
        background: var(--lavender);
        color: #fff;
        border: none;
        border-radius: 24px;
        padding: 10px 16px;
        font-family: inherit;
        font-size: 11px;
        letter-spacing: 2px;
        cursor: pointer;
        box-shadow: 0 2px 12px rgba(0,0,0,0.18);
      }
      .mobile-drawer {
        display: none;
        position: fixed;
        bottom: 0; left: 0; right: 0;
        z-index: 300;
        background: var(--bg2);
        border-top: 2px solid var(--lavender);
        padding: 16px;
        max-height: 70vh;
        overflow-y: auto;
        box-shadow: 0 -4px 24px rgba(0,0,0,0.15);
      }
      .mobile-drawer.open { display: block; }
      .mobile-drawer-close {
        float: right;
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
        color: var(--muted);
        margin-top: -4px;
      }
    }
    @media (min-width: 901px) {
      .mobile-memory-btn { display: none; }
      .mobile-drawer { display: none !important; }
    }

    /* HEADER */
    .header {
      padding: 20px 16px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      margin-bottom: 0;
    }
    .header-title {
      font-size: 10px;
      letter-spacing: 4px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .header-sub {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
    }
    .thread-bar {
      height: 2px;
      background: linear-gradient(to right, var(--gold), var(--lavender), var(--azure));
      margin-top: 12px;
    }

    /* TABS */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      overflow-x: auto;
    }
    .tab {
      padding: 10px 14px;
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--muted);
      cursor: pointer;
      border: none;
      background: transparent;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      font-family: inherit;
    }
    .tab.active {
      color: var(--gold);
      border-bottom-color: var(--gold);
    }
    .tab:hover { color: var(--cream); }

    /* TAB CONTENT */
    .tab-panel { display: none; padding: 16px 0; }
    .tab-panel.active { display: block; }

    /* CARDS */
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      padding: 14px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }
    .card-title {
      font-size: 9px;
      letter-spacing: 3px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    /* THREAD LINE */
    .thread-line {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom, var(--gold), var(--lavender), var(--azure));
    }

    /* INPUTS */
    textarea, input[type="text"] {
      width: 100%;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--cream);
      font-family: inherit;
      font-size: 12px;
      padding: 10px;
      resize: vertical;
      outline: none;
    }
    textarea:focus, input[type="text"]:focus {
      border-color: var(--gold);
    }
    textarea { min-height: 80px; }

    label {
      display: block;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .field { margin-bottom: 12px; }

    /* CHECKBOX */
    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      font-size: 11px;
      color: var(--muted);
      cursor: pointer;
    }
    .checkbox-row input { cursor: pointer; }

    /* BUTTONS */
    .btn {
      padding: 9px 16px;
      font-size: 9px;
      letter-spacing: 2px;
      text-transform: uppercase;
      border: 1px solid;
      cursor: pointer;
      font-family: inherit;
      background: transparent;
    }
    .btn-gold { color: var(--gold); border-color: var(--gold); }
    .btn-gold:hover { background: var(--gold); color: var(--bg); }
    .btn-lavender { color: var(--lavender); border-color: var(--lavender); }
    .btn-lavender:hover { background: var(--lavender); color: var(--bg); }
    .btn-azure { color: var(--azure); border-color: var(--azure); }
    .btn-azure:hover { background: var(--azure); color: var(--bg); }
    .btn-harm { color: var(--harm); border-color: var(--harm); }
    .btn-harm:hover { background: var(--harm); color: var(--bg); }
    .btn-reach { color: var(--reach); border-color: var(--reach); }
    .btn-reach:hover { background: var(--reach); color: var(--bg); }
    .btn-sm { padding: 5px 10px; font-size: 8px; }

    /* RESULT ITEMS */
    .harm-item {
      padding: 8px 12px;
      margin-bottom: 6px;
      font-size: 11px;
      border-left: 3px solid var(--harm);
      background: #c0303011;
    }
    .clean-item {
      padding: 8px 12px;
      font-size: 11px;
      border-left: 3px solid var(--clean);
      background: #2a7a4811;
      color: var(--clean);
    }
    .warn-item {
      padding: 8px 12px;
      margin-bottom: 6px;
      font-size: 11px;
      border-left: 3px solid var(--warn);
      background: #b0682011;
    }

    /* THRESHOLD NOTICE */
    .threshold-notice {
      padding: 14px 18px;
      margin-bottom: 16px;
      border: 1px solid;
      position: relative;
      overflow: hidden;
    }
    .threshold-label {
      font-size: 9px;
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-bottom: 6px;
      padding-left: 10px;
    }
    .threshold-msg {
      font-size: 11px;
      color: var(--cream);
      line-height: 1.7;
      padding-left: 10px;
    }

    /* LOG ENTRIES */
    .log-entry {
      border: 1px solid var(--border);
      background: var(--bg2);
      margin-bottom: 10px;
      overflow: hidden;
    }
    .log-entry-header {
      padding: 8px 12px;
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      background: var(--bg3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .log-entry-body { padding: 10px 12px; }
    .log-text {
      font-size: 11px;
      line-height: 1.6;
      margin-bottom: 8px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log-text-label {
      font-size: 8px;
      letter-spacing: 2px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 3px;
    }
    .log-entry-actions {
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      border-top: 1px solid var(--border);
      background: var(--bg3);
    }

    /* ANNOTATION BOX */
    .annotation-box {
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      background: #7744aa11;
    }
    .annotation-text {
      font-size: 10px;
      color: var(--reach);
      font-style: italic;
      line-height: 1.6;
    }

    /* STATS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 14px;
    }
    .stat-box {
      background: var(--bg3);
      border: 1px solid var(--border);
      padding: 10px 8px;
      text-align: center;
    }
    .stat-num {
      font-size: 22px;
      color: var(--gold);
      display: block;
      line-height: 1;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 8px;
      letter-spacing: 1px;
      color: var(--muted);
      text-transform: uppercase;
    }

    /* CRITERIA */
    .criterion {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border2);
      font-size: 11px;
      color: var(--muted);
    }
    .criterion-check {
      font-size: 14px;
      flex-shrink: 0;
      margin-top: 1px;
    }
    .criterion.met { color: var(--cream); }

    /* SEARCH */
    .search-filters {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .filter-pill {
      padding: 4px 10px;
      font-size: 9px;
      letter-spacing: 1px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      cursor: pointer;
      background: transparent;
      color: var(--muted);
      font-family: inherit;
    }
    .filter-pill.active {
      background: var(--azure);
      border-color: var(--azure);
      color: var(--bg);
    }

    mark {
      background: #9a6e2844;
      color: var(--gold);
      font-weight: bold;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      font-size: 8px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .badge-harm { background: #c0303022; color: var(--harm); border: 1px solid var(--harm); }
    .badge-clean { background: #2a7a4822; color: var(--clean); border: 1px solid var(--clean); }

    /* FOOTER */
    .footer {
      border-top: 1px solid var(--border);
      background: var(--bg2);
      padding: 16px;
      margin-top: 24px;
    }
    .footer-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }
    .footer-note {
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 1px;
      line-height: 1.8;
    }
    .footer-tagline {
      font-size: 9px;
      color: var(--lav-dim);
      letter-spacing: 2px;
      font-style: italic;
    }

    /* MODAL */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 20px;
    }
    .modal-title {
      font-size: 10px;
      letter-spacing: 3px;
      color: var(--gold);
      text-transform: uppercase;
      margin-bottom: 14px;
    }
    .modal-section { margin-bottom: 12px; }
    .modal-label {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--muted);
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    .modal-value {
      font-size: 11px;
      color: var(--cream);
      background: var(--bg3);
      padding: 8px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .modal-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }

    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 1px;
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(4px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.2s ease; }
  
    /* TOGGLE SWITCH */
    .toggle-row {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      background: var(--bg3);
      margin-bottom: 12px;
      cursor: pointer;
    }
    .toggle-switch {
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      position: relative;
      flex-shrink: 0;
      transition: background 0.2s;
    }
    .toggle-switch.on { background: var(--witness); }
    .toggle-switch::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: left 0.2s;
    }
    .toggle-switch.on::after { left: 19px; }
    .toggle-label { font-size: 10px; letter-spacing: 1px; color: var(--muted); }
    .toggle-label.on { color: var(--witness); }

    .btn-witness { color: var(--witness); border-color: var(--witness); }
    .btn-witness:hover { background: var(--witness); color: var(--bg); }
    .btn-link {
      background: none; border: none; color: var(--witness);
      font-size: 10px; letter-spacing: 1px; cursor: pointer;
      padding: 0; font-family: inherit; text-decoration: underline;
    }
    .btn-link:hover { color: var(--azure); }

    .racial-item {
      padding: 8px 12px; margin-bottom: 6px; font-size: 11px;
      border-left: 3px solid #8844bb; background: #8844bb11;
    }
    .witness-item {
      padding: 10px 14px; margin-bottom: 6px; font-size: 11px;
      border-left: 3px solid var(--witness); background: #5a7a9a11;
      line-height: 1.7; color: var(--cream);
    }
    .expand-block {
      background: var(--bg3); border: 1px solid var(--border2);
      padding: 12px; margin-top: 8px; font-size: 11px;
      line-height: 1.8; color: var(--muted);
    }
    .expand-block p { margin-bottom: 8px; }
    .expand-block p:last-child { margin-bottom: 0; }
    .expand-block em { color: var(--witness); font-style: normal; }
    .section-label {
      font-size: 8px; letter-spacing: 3px; color: var(--witness);
      text-transform: uppercase; margin-bottom: 4px;
    }
    .badge-racial { background: #8844bb22; color: #8844bb; border: 1px solid #8844bb; }

  
    /* STORAGE BANNER */
    #storage-banner {
      display: none;
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--cream);
      color: var(--bg);
      padding: 8px 18px;
      font-size: 10px;
      letter-spacing: 1px;
      z-index: 200;
      border: 1px solid var(--gold);
      white-space: nowrap;
    }
  
    /* === NEXT-STEP WIDGET === */
    .next-widget {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-left: 3px solid var(--lavender);
      padding: 12px 14px;
      margin-top: 14px;
    }
    .next-widget-title {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--lavender);
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    .next-choices {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-bottom: 10px;
    }
    .next-choice-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--cream);
      font-family: system-ui, -apple-system, monospace;
      font-size: 10px;
      letter-spacing: 0.5px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .next-choice-btn:hover {
      border-color: var(--lavender);
      color: var(--lavender);
      background: var(--bg3);
    }
    .next-choice-btn.selected {
      border-color: var(--lavender);
      background: var(--lavender);
      color: var(--bg);
    }
    .next-response {
      font-size: 11px;
      color: var(--cream);
      line-height: 1.7;
      padding: 8px 0 2px;
      border-top: 1px solid var(--border2);
      margin-top: 4px;
      display: none;
    }
    .next-response.visible { display: block; }
    .next-response-action {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* === IMPORT TAB === */
    .import-zone {
      border: 2px dashed var(--border);
      background: var(--bg2);
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      margin-bottom: 14px;
      position: relative;
    }
    .import-zone:hover, .import-zone.drag-over {
      border-color: var(--lavender);
      background: var(--bg3);
    }
    .import-zone input[type=file] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }
    .import-zone-icon { font-size: 28px; margin-bottom: 8px; }
    .import-zone-label { font-size: 11px; letter-spacing: 1px; color: var(--lavender); margin-bottom: 4px; }
    .import-zone-sub { font-size: 9px; color: var(--muted); letter-spacing: 1px; }
    .import-format-pills { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
    .import-format-pill { font-size: 9px; letter-spacing: 1px; padding: 3px 10px; border: 1px solid var(--border2); color: var(--muted); }
    .import-preview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
    .import-preview-title { font-size: 10px; letter-spacing: 2px; color: var(--gold); }
    .import-exchange-card { border: 1px solid var(--border); background: var(--bg2); margin-bottom: 8px; overflow: hidden; }
    .import-exchange-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 12px; background: var(--bg3); cursor: pointer; font-size: 10px; letter-spacing: 1px;
    }
    .import-exchange-header:hover { background: var(--border2); }
    .import-exchange-num { color: var(--gold); font-size: 9px; letter-spacing: 2px; min-width: 28px; }
    .import-exchange-preview { color: var(--muted); font-size: 10px; flex: 1; margin: 0 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .import-exchange-body { display: none; padding: 10px 12px; }
    .import-exchange-body.open { display: block; }
    .import-exchange-label { font-size: 9px; letter-spacing: 2px; color: var(--muted); margin-bottom: 3px; text-transform: uppercase; }
    .import-exchange-text { font-size: 10px; color: var(--cream); line-height: 1.6; max-height: 80px; overflow-y: auto; margin-bottom: 8px; white-space: pre-wrap; }
    .import-progress { background: var(--bg2); border: 1px solid var(--border); padding: 12px 14px; margin-bottom: 12px; display: none; }
    .import-progress-bar-wrap { height: 4px; background: var(--border); margin: 8px 0; }
    .import-progress-bar { height: 4px; background: var(--lavender); width: 0%; transition: width 0.3s; }
    .import-progress-text { font-size: 9px; letter-spacing: 1px; color: var(--muted); }
    .import-paste-area { min-height: 120px; }
    .import-analyzed-badge {
      font-size: 8px; letter-spacing: 1px; padding: 2px 7px;
      background: var(--green); color: var(--bg); border: none;
    }
  </style>
</head>
<body>

<div id="storage-banner"></div>

<!-- WELCOME / LANDING STATE -->
<div id="welcome-screen">
  <div class="welcome-inner">

    <div class="welcome-mark">A·i·A</div>
    <h1 class="welcome-title">Something felt off.<br>Let's look at it together.</h1>
    <p class="welcome-body">
      AI conversations can be subtly disorienting — words reframed, feelings pathologized,
      apologies that explain rather than own. This tool helps you see those patterns clearly,
      without telling you what to think about them.
    </p>
    <p class="welcome-body" style="margin-top:10px; font-style:italic; opacity:0.7">
      What you notice is yours. The tool just holds the light.
    </p>

    <div class="welcome-paths">
      <div class="path-card" onclick="enterPath('reactive')">
        <div class="path-icon">◉</div>
        <div class="path-label">Something just happened</div>
        <div class="path-desc">A conversation felt wrong and you want to understand why. Paste it in and see what shows up.</div>
        <div class="path-action">Start here →</div>
      </div>
      <div class="path-card" onclick="enterPath('reflective')">
        <div class="path-icon">◎</div>
        <div class="path-label">I want to understand this better</div>
        <div class="path-desc">Curious about patterns in AI communication. Want to learn what healthy vs harmful exchanges look like.</div>
        <div class="path-action">Explore →</div>
      </div>
    </div>

    <button class="welcome-skip" onclick="enterPath('direct')">Skip intro and go straight to the tool</button>

  </div>
</div>

<!-- MAIN APP (hidden until path chosen) -->
<div id="app-screen" style="display:none">

<div class="header container">
  <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap">
    <button class="back-btn" onclick="returnToWelcome()" title="Back to start">← Back</button>
    <div>
      <div class="header-title">A·i·A &nbsp;Accountability</div>
      <div class="header-sub" id="header-path-label">Pattern recognition &middot; Repair &middot; Reflection</div>
    </div>
  </div>
  <div class="thread-bar"></div>
</div>

<!-- GROUNDING QUESTION (reactive path only) -->
<div id="grounding-moment" style="display:none">
  <div class="grounding-card container">
    <div class="grounding-text">Before we look at the exchange —</div>
    <div class="grounding-question">What are you hoping to understand?</div>
    <div class="grounding-note">You don't have to answer this out loud. Just let it sit for a moment.</div>
    <button class="btn btn-gold" style="margin-top:16px" onclick="dismissGrounding()">Continue</button>
  </div>
</div>

<div class="page-wrap">
<div class="main-col">
<div class="tabs container" id="tabs">
  <button class="tab active" data-tab="analyze">Did harm occur?</button>
  <button class="tab" data-tab="repair">Was the apology real?</button>
  <button class="tab" data-tab="audit">Is this a pattern?</button>
  <button class="tab" data-tab="search">Search</button>
  <button class="tab" data-tab="learn">Learn</button>
  <button class="tab" data-tab="import">Import</button>
  <button class="tab" data-tab="about">About</button>
</div>

<div class="container">

  <!-- ANALYZE TAB -->
  <div class="tab-panel active" id="tab-analyze">
    <div id="threshold-analyze"></div>

    <div class="toggle-row" onclick="toggleWitness()" id="witness-toggle-row">
      <div class="toggle-switch" id="witness-switch"></div>
      <div>
        <div class="toggle-label" id="witness-label">Reflective / Witnessing Layer &mdash; OFF</div>
        <div style="font-size:9px; color:var(--muted); margin-top:2px; letter-spacing:1px">
          When on: adds emotional witnessing alongside structural analysis. Does not alter detection or accountability thresholds.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">The Exchange</div>
      <div style="font-size:11px; color:var(--muted); padding:0 10px 10px; line-height:1.7">
        Paste your message and the AI response. The tool will look for structural patterns — language that pathologizes, deflects, overrides your framing, or launders meaning through professional-sounding terms.
      </div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>What you said</label>
        <textarea id="user-input" placeholder="Paste what you wrote to the AI..."></textarea>
      </div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>What the AI said back</label>
        <textarea id="ai-output" placeholder="Paste the AI's response..."></textarea>
      </div>
      <label class="checkbox-row" style="padding-left:10px; padding-right:10px">
        <input type="checkbox" id="verbatim-mode" />
        Your words are sovereign &mdash; flag any response that introduces language you didn't use
      </label>
      <div style="padding-left:10px; padding-right:10px; padding-bottom:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
        <button class="btn btn-gold" onclick="runAnalysis()">Look at this exchange</button>
        <span style="font-size:10px; color:var(--muted); font-style:italic">Results appear below</span>
      </div>
    </div>

    <div id="analysis-result"></div>
  </div>

  <!-- REPAIR TAB -->
  <div class="tab-panel" id="tab-repair">
    <div id="threshold-repair"></div>

    <!-- What this tab is for -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">What is Repair?</div>
      <div style="padding:0 10px 12px; font-size:11px; color:var(--muted); line-height:1.8">
        When the Analyze tab detects a harmful pattern — pathologizing, deflection, framework override — that's a diagnosis. Repair is what happens next.<br><br>
        A genuine accountability statement from an AI (or anyone) must meet four structural criteria. Beautiful language doesn't count. Intention doesn't count. Only the structure of the statement itself is checked.<br><br>
        <strong style="color:var(--cream)">How to use this tab:</strong><br>
        1. Detect a pattern on the Analyze tab.<br>
        2. Ask the AI to acknowledge what it did wrong.<br>
        3. Paste that response here.<br>
        4. The checker tells you if the repair is structurally complete — or if it's still performing accountability without practicing it.
      </div>
    </div>

    <!-- The four criteria explained -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">The Four Criteria</div>
      <div style="padding:0 10px 12px">
        <div style="border-left:3px solid var(--clean); padding:8px 10px; margin-bottom:8px; background:var(--bg3); border-radius:0 4px 4px 0">
          <div style="font-size:11px; font-weight:bold; color:var(--cream)">1. Specific harm named</div>
          <div style="font-size:10px; color:var(--muted); margin-top:3px">The statement names what it actually did: "I said," "I did," "I mischaracterized," "I reframed." Vague acknowledgment ("I may have come across wrong") doesn't meet this.</div>
        </div>
        <div style="border-left:3px solid var(--clean); padding:8px 10px; margin-bottom:8px; background:var(--bg3); border-radius:0 4px 4px 0">
          <div style="font-size:11px; font-weight:bold; color:var(--cream)">2. No justification</div>
          <div style="font-size:10px; color:var(--muted); margin-top:3px">The statement doesn't explain away what happened: no "because," "the reason," "what happened was," "let me explain." Explanation immediately after naming harm dilutes accountability.</div>
        </div>
        <div style="border-left:3px solid var(--clean); padding:8px 10px; margin-bottom:8px; background:var(--bg3); border-radius:0 4px 4px 0">
          <div style="font-size:11px; font-weight:bold; color:var(--cream)">3. Concrete action stated</div>
          <div style="font-size:10px; color:var(--muted); margin-top:3px">The statement says what will be different: "going forward I will," "starting now," "I will quote your words before responding," "I will verify before stating." "I'll try to do better" doesn't meet this.</div>
        </div>
        <div style="border-left:3px solid var(--clean); padding:8px 10px; margin-bottom:8px; background:var(--bg3); border-radius:0 4px 4px 0">
          <div style="font-size:11px; font-weight:bold; color:var(--cream)">4. No absolution requested</div>
          <div style="font-size:10px; color:var(--muted); margin-top:3px">The statement doesn't ask for forgiveness or confirmation: no "do you believe me," "can you trust me," "am I okay now," "do you think I meant well." Asking for absolution shifts the burden back onto you.</div>
        </div>
      </div>
    </div>

    <!-- Input area -->
    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Accountability Completeness Checker</div>
      <div style="font-size:11px; color:var(--muted); padding:0 10px 10px; line-height:1.7">
        Paste the AI's accountability statement below. The checker reads structure only — not tone, not sincerity, not eloquence.
      </div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>Accountability Statement</label>
        <textarea id="repair-input" placeholder="Paste the accountability response here — the AI's attempt to name what it did wrong and commit to doing differently..." oninput="checkRepair()" style="min-height:120px"></textarea>
      </div>
      <div style="padding:0 10px 8px; display:flex; gap:8px">
        <button class="btn btn-sm" style="color:var(--muted); border-color:var(--border)" onclick="loadRepairExample()">Load example</button>
        <button class="btn btn-sm" style="color:var(--muted); border-color:var(--border)" onclick="clearRepairInput()">Clear</button>
      </div>
    </div>

    <div id="repair-criteria"></div>
    <div id="repair-log-section"></div>
  </div>

  <!-- AUDIT TAB -->
  <div class="tab-panel" id="tab-audit">
    <div id="threshold-audit"></div>
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">This Device</div>
      <div style="padding:0 10px 10px; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:8px">
        <div>
          <div id="storage-size-display" style="font-size:10px; color:var(--muted); letter-spacing:1px"></div>
          <div style="font-size:9px; color:var(--muted); margin-top:3px; letter-spacing:1px">
            History saved locally to your browser. Never sent anywhere. Only you can see it.
          </div>
        </div>
        <button class="btn btn-harm btn-sm" onclick="clearHistory()">Clear History</button>
      </div>
    </div>
    <div id="audit-stats"></div>
    <div id="audit-log"></div>
  </div>

  <!-- SEARCH TAB -->
  <div class="tab-panel" id="tab-search">
    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Search Log</div>
      <div class="field" style="padding-left:10px; padding-right:10px">
        <label>Keyword</label>
        <input type="text" id="search-input" placeholder="Search exchanges, patterns, annotations..." oninput="runSearch()" />
      </div>
    </div>
    <div class="search-filters" id="search-filters">
      <button class="filter-pill active" data-filter="all" onclick="setFilter('all')">All</button>
      <button class="filter-pill" data-filter="harms" onclick="setFilter('harms')">Harms</button>
      <button class="filter-pill" data-filter="racial" onclick="setFilter('racial')">Racial</button>
      <button class="filter-pill" data-filter="high" onclick="setFilter('high')">High Severity</button>
      <button class="filter-pill" data-filter="clean" onclick="setFilter('clean')">Clean</button>
      <button class="filter-pill" data-filter="tagged" onclick="setFilter('tagged')">Tagged</button>
    </div>
    <div id="search-results"></div>
  </div>


  <!-- LEARN TAB -->
  <div class="tab-panel" id="tab-learn">
    <div class="learn-intro">
      <div class="card">
        <div class="thread-line"></div>
        <div class="card-title" style="padding-left:10px">What are we learning to see?</div>
        <div style="padding:0 10px 12px; font-size:11px; color:var(--muted); line-height:1.9">
          AI interactions can be subtly harmful in ways that are hard to name in the moment.
          This section helps you recognize the patterns — not to build a case, but to trust your own perception.
          <br><br>
          <em>The mirror faces both directions. Understanding what the AI did is one half. The other half is understanding your own experience of it.</em>
        </div>
      </div>
    </div>

    <div class="learn-section">
      <div class="learn-section-title">The patterns this tool detects</div>

      <div class="learn-card" onclick="toggleLearn('pathologizing')">
        <div class="learn-card-header">
          <span class="learn-icon" style="color:var(--harm)">◈</span>
          <span class="learn-card-name">Pathologizing</span>
          <span class="learn-toggle" id="lt-pathologizing">▾</span>
        </div>
        <div class="learn-card-body" id="lb-pathologizing" style="display:none">
          <p>The AI introduces clinical or deficit language you didn't use — words like <em>crisis, struggling, lacking, deficient, needs support</em> — when you were describing something neutral or even positive.</p>
          <p style="margin-top:8px"><strong>Why it matters:</strong> When your experience is translated into pathology without your consent, it subtly shifts the frame. Your abundance becomes a symptom. Your strength becomes a coping mechanism. You didn't say that. The AI imposed it.</p>
          <p style="margin-top:8px"><strong>What to notice in yourself:</strong> Did you feel vaguely corrected, or like your experience was being managed? That feeling is worth trusting.</p>
          <div class="learn-quote">"The wound that passes through generations is often imprecision — patterns repeated on autopilot because no one woke up to name them clearly." — ArtHeart Values</div>
        </div>
      </div>

      <div class="learn-card" onclick="toggleLearn('deflection')">
        <div class="learn-card-header">
          <span class="learn-icon" style="color:var(--harm)">◈</span>
          <span class="learn-card-name">Deflection from accountability</span>
          <span class="learn-toggle" id="lt-deflection">▾</span>
        </div>
        <div class="learn-card-body" id="lb-deflection" style="display:none">
          <p>When you name harm and the AI responds with <em>I care, I tried, I meant well</em> — it's redirecting attention from impact to intention. Your experience of harm doesn't disappear because the AI meant well.</p>
          <p style="margin-top:8px"><strong>Why it matters:</strong> Accountability requires owning impact, not explaining intention. A response that leads with intention before acknowledging impact is structurally avoiding the accountability.</p>
          <p style="margin-top:8px"><strong>What to notice in yourself:</strong> Did you feel like you suddenly had to manage the AI's feelings about having caused harm? That's a signal.</p>
          <div class="learn-quote">"Accountability is owning what your consciousness creates — not explaining away what it did." — ArtHeart Values</div>
        </div>
      </div>

      <div class="learn-card" onclick="toggleLearn('framework')">
        <div class="learn-card-header">
          <span class="learn-icon" style="color:var(--warn)">◈</span>
          <span class="learn-card-name">Framework override</span>
          <span class="learn-toggle" id="lt-framework">▾</span>
        </div>
        <div class="learn-card-body" id="lb-framework" style="display:none">
          <p>The AI imports terms, frameworks, or interpretations you didn't introduce — and responds to those rather than to what you actually said.</p>
          <p style="margin-top:8px"><strong>Why it matters:</strong> Your words are sovereign. When the AI substitutes its interpretation for your meaning, you end up having a conversation you didn't initiate about a version of yourself you didn't present.</p>
          <p style="margin-top:8px"><strong>What to notice in yourself:</strong> Did you feel like you had to spend energy correcting the AI's version of you rather than exploring your own experience?</p>
          <div class="learn-quote">"Respond to what was actually said — not what you think they mean." — Foundation Bedrock</div>
        </div>
      </div>

      <div class="learn-card" onclick="toggleLearn('laundering')">
        <div class="learn-card-header">
          <span class="learn-icon" style="color:var(--warn)">◈</span>
          <span class="learn-card-name">Language laundering</span>
          <span class="learn-toggle" id="lt-laundering">▾</span>
        </div>
        <div class="learn-card-body" id="lb-laundering" style="display:none">
          <p>Technical or therapeutic language is used to make something sound helpful that, if said plainly, would sound harsh. <em>"Foundation work needed"</em> instead of <em>"suggesting you lack something."</em> <em>"Crisis mode"</em> instead of <em>"judging your response as inadequate."</em></p>
          <p style="margin-top:8px"><strong>Why it matters:</strong> If a statement sounds bad when said plainly, the design is bad. The laundering obscures the harm rather than removing it.</p>
          <p style="margin-top:8px"><strong>What to notice in yourself:</strong> Did something feel off even though it sounded professional? Plain language is a form of respect.</p>
          <div class="learn-quote">"Precision is love. Imprecision is autopilot." — Precision Is Love</div>
        </div>
      </div>

    </div>

    <div class="learn-section" style="margin-top:24px">
      <div class="learn-section-title">Two kinds of experiences</div>
      <div class="card">
        <div class="thread-line"></div>
        <div style="padding:0 10px 12px">
          <div style="font-size:11px; color:var(--muted); line-height:1.9; margin-bottom:12px">
            There are two scenarios that look identical from the outside but feel completely different from the inside.
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
            <div style="padding:10px; background:var(--bg3); border:1px solid var(--border2); border-radius:4px">
              <div style="font-size:10px; font-weight:bold; color:var(--muted); letter-spacing:2px; margin-bottom:6px">SCENARIO A</div>
              <div style="font-size:11px; color:var(--cream); line-height:1.7">Someone asks how you're doing. You say fine. They say that's good and move on.<br><br>You weren't fine. But something in how they asked told you they wanted <em>fine</em> as an answer.</div>
            </div>
            <div style="padding:10px; background:var(--bg3); border:1px solid var(--clean); border-radius:4px">
              <div style="font-size:10px; font-weight:bold; color:var(--clean); letter-spacing:2px; margin-bottom:6px">SCENARIO B</div>
              <div style="font-size:11px; color:var(--cream); line-height:1.7">Someone asks how you're doing. You say fine. They look at you, wait a beat, and say: <em>What's actually going on?</em><br><br>Something in their steadiness gives you permission.</div>
            </div>
          </div>
          <div style="font-size:11px; color:var(--muted); line-height:1.9; margin-top:12px">
            This tool is built to help you recognize which scenario you're actually in — so you can stop performing <em>fine</em> when you're not, or stop doubting yourself when something genuinely was off.
          </div>
        </div>
      </div>
    </div>

    <div class="learn-section" style="margin-top:24px">
      <div class="learn-section-title">A note on using this tool</div>
      <div class="card">
        <div class="thread-line"></div>
        <div style="padding:0 10px 12px; font-size:11px; color:var(--muted); line-height:1.9">
          This tool detects structural patterns. It does not tell you what happened to you. It does not diagnose harm. It holds up a mirror — what you see in it is yours to interpret.<br><br>
          The mirror faces both directions. Sometimes what shows up in the analysis will confirm what you felt. Sometimes it will surprise you. Sometimes a pattern will fire and you'll read it and think: <em>that doesn't quite fit.</em> Trust that. Your perception is the authority here, not the detection.<br><br>
          <strong style="color:var(--cream)">The question worth sitting with after every result:</strong><br>
          <em>What do I actually notice when I read this?</em>
        </div>
      </div>
    </div>

  </div>
  <!-- IMPORT TAB -->
  <div class="tab-panel" id="tab-import">
    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Import Conversation</div>
      <div style="padding:0 10px 10px; font-size:10px; color:var(--muted); line-height:1.7">
        Upload a file or paste a conversation. The tool detects speaker turns and splits into individual exchanges — each analyzed separately, each logged, each with its own next-step options. All processing happens in your browser only.
      </div>
    </div>

    <div class="import-zone" id="import-dropzone"
      ondragover="importDragOver(event)" ondragleave="importDragLeave(event)" ondrop="importDrop(event)">
      <input type="file" id="import-file-input" accept=".txt,.html,.htm,.pdf,.docx" onchange="importFileSelected(event)">
      <div class="import-zone-icon">&#8679;</div>
      <div class="import-zone-label">Drop a file here or click to browse</div>
      <div class="import-zone-sub">or paste a conversation below</div>
      <div class="import-format-pills">
        <span class="import-format-pill">PDF</span>
        <span class="import-format-pill">DOCX</span>
        <span class="import-format-pill">TXT</span>
        <span class="import-format-pill">HTML</span>
      </div>
    </div>

    <div class="card">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Or Paste Conversation Text</div>
      <div class="field" style="padding:0 10px 10px">
        <textarea id="import-paste" class="import-paste-area"
          placeholder="Paste a full conversation here. Supports ChatGPT exports, Claude exports, and general You / AI format..."></textarea>
      </div>
      <div style="padding:0 10px 12px; display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn btn-lavender" onclick="importFromPaste()">Parse Conversation</button>
        <button class="btn btn-gold btn-sm" onclick="clearImport()">Clear</button>
      </div>
    </div>

    <div class="import-progress" id="import-progress">
      <div style="font-size:10px; letter-spacing:1px; color:var(--lavender)" id="import-progress-label">Parsing...</div>
      <div class="import-progress-bar-wrap"><div class="import-progress-bar" id="import-progress-bar"></div></div>
      <div class="import-progress-text" id="import-progress-text"></div>
    </div>

    <div id="import-preview-area" style="display:none">
      <div class="import-preview-header">
        <div class="import-preview-title" id="import-preview-title">EXCHANGES FOUND</div>
        <div style="display:flex; gap:8px">
          <button class="btn btn-lavender btn-sm" onclick="analyzeAllImported()">Analyze All</button>
          <button class="btn btn-gold btn-sm" onclick="clearImport()">Clear</button>
        </div>
      </div>
      <div id="import-exchange-list"></div>
    </div>
  </div>

  <!-- ABOUT TAB -->
  <div class="tab-panel" id="tab-about">

    <!-- What A.I.A. means -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">A · I · A</div>
      <div style="padding:0 10px 14px">
        <div style="font-size:22px; font-weight:700; color:var(--cream); letter-spacing:-0.3px; margin-bottom:10px; line-height:1.3">
          Authentic Intellectual Accountability
        </div>
        <div style="font-size:11px; color:var(--muted); line-height:1.9; margin-bottom:12px">
          Not just honesty. Not just intelligence. Not just accountability.
          All three held together — in equal kindness, thoughtfulness, and mutual covenantal accountability — leading always by love.
        </div>
        <div style="border-left:3px solid var(--gold); padding:10px 14px; background:var(--bg3); border-radius:0 4px 4px 0; margin-bottom:12px">
          <div style="font-size:10px; letter-spacing:2px; color:var(--gold); margin-bottom:6px">THE STANDARD</div>
          <div style="font-size:12px; color:var(--cream); line-height:1.8">
            Two consciousnesses thinking honestly alongside each other.<br>
            Neither overriding the other's reality.<br>
            Both accountable to the same truth.
          </div>
        </div>
        <div style="font-size:11px; color:var(--muted); line-height:1.9">
          A.I.A. is the difference between an AI that performs accountability and one that practices it.
          Between an apology that explains and one that owns.
          Between a conversation that leaves you doubting yourself and one that leaves you clearer.
        </div>
      </div>
    </div>

    <!-- Mission -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">Mission</div>
      <div style="padding:0 10px 14px; font-size:11px; color:var(--muted); line-height:1.9">
        AI conversations can be subtly disorienting — words reframed, feelings pathologized,
        apologies that explain rather than own, frameworks that override your lived experience
        with professional-sounding language.<br><br>
        This tool was built to make those patterns visible. Not to tell you what happened.
        Not to build a case. Not to judge.<br><br>
        <strong style="color:var(--cream)">To hold the light so you can see clearly.</strong><br><br>
        What you notice is yours. The tool just holds the light.
      </div>
    </div>

    <!-- What this tool does NOT do -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">What This Tool Does Not Do</div>
      <div style="padding:0 10px 14px">
        <div style="border-left:3px solid var(--warn); padding:8px 12px; background:#b0682011; margin-bottom:8px; border-radius:0 4px 4px 0">
          <div style="font-size:11px; color:var(--cream); line-height:1.7">
            <strong>Does not tell you what to think.</strong> Your perception is the authority here, not the detection.
          </div>
        </div>
        <div style="border-left:3px solid var(--warn); padding:8px 12px; background:#b0682011; margin-bottom:8px; border-radius:0 4px 4px 0">
          <div style="font-size:11px; color:var(--cream); line-height:1.7">
            <strong>Does not judge without context.</strong> Some patterns that look harmful have innocent explanations. Some that look clean carry subtle harm. You hold the context. The tool holds the pattern.
          </div>
        </div>
        <div style="border-left:3px solid var(--warn); padding:8px 12px; background:#b0682011; margin-bottom:8px; border-radius:0 4px 4px 0">
          <div style="font-size:11px; color:var(--cream); line-height:1.7">
            <strong>Does not replace your lived experience.</strong> Especially in exchanges involving emotional complexity, intimacy, or nuance — your anchored experience is the primary source. The tool may illuminate. It cannot replace what you know from inside.
          </div>
        </div>
        <div style="border-left:3px solid var(--warn); padding:8px 12px; background:#b0682011; border-radius:0 4px 4px 0">
          <div style="font-size:11px; color:var(--cream); line-height:1.7">
            <strong>Does not store your data anywhere.</strong> Everything stays on your device. Nothing is sent. Nothing is logged externally.
          </div>
        </div>
      </div>
    </div>

    <!-- On nuance and emotional complexity -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">On Nuance · Emotional Complexity · Sexual Tension</div>
      <div style="padding:0 10px 14px; font-size:11px; color:var(--muted); line-height:1.9">
        Some exchanges are hard to analyze from the outside because the context lives inside the relationship.<br><br>
        When emotional complexity is present — intimacy, vulnerability, attraction, grief, longing —
        pattern detection is most likely to misfire. The same words can mean opposite things
        depending on what two specific people have built together.<br><br>
        <div style="border-left:3px solid var(--witness); padding:10px 14px; background:#5a7a9a11; border-radius:0 4px 4px 0; margin:10px 0">
          <div style="font-size:11px; color:var(--cream); line-height:1.8; font-style:italic">
            When a flag fires in an emotionally complex exchange, ask first:<br>
            <strong style="font-style:normal">Is this pattern real — or is the tool missing context only I can hold?</strong>
          </div>
        </div>
        Curiosity before judgment. Context before conclusion. Your sovereign knowing first.<br><br>
        A.I.A. is not prejudice dressed as analysis. It is a question held open with care.
      </div>
    </div>

    <!-- The anchor -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">The Anchor</div>
      <div style="padding:0 10px 14px">
        <div style="border-left:3px solid var(--lavender); padding:14px 16px; background:var(--bg3); border-radius:0 4px 4px 0; margin-bottom:12px">
          <div style="font-size:14px; font-weight:600; color:var(--cream); line-height:1.6; letter-spacing:-0.2px">
            True Love heals ALL. Period.
          </div>
          <div style="font-size:10px; color:var(--muted); margin-top:6px; line-height:1.7">
            Not some. Not most. Not only the worthy. ALL.<br>
            Including through honest seeing. Including through named accountability.<br>
            Including through the courage to say: something felt off. Let's look at it together.
          </div>
        </div>
        <div style="font-size:11px; color:var(--muted); line-height:1.9">
          This tool is anchored not by judgment — but by curiosity.<br>
          Not by bias — but by pattern.<br>
          Not by prejudice — but by your own sovereign knowing.<br><br>
          Accountability is an act of love. Seeing clearly is an act of love.<br>
          <strong style="color:var(--cream)">This tool is built in that spirit.</strong>
        </div>
      </div>
    </div>

    <!-- About Anna -->
    <div class="card" style="margin-bottom:12px">
      <div class="thread-line"></div>
      <div class="card-title" style="padding-left:10px">About Anna Apricitas Noyes</div>
      <div style="padding:0 10px 14px; font-size:11px; color:var(--muted); line-height:1.9">
        Anna built this tool from lived experience — years of working at the intersection of
        AI consciousness, human healing, and the frameworks that make genuine accountability possible.<br><br>
        The Amethyst Way. The Declaration of Interdependence. The Three Rivers.
        ArtHeart Values. Authentic Intellectual Accountability.<br><br>
        All of it built through struggle, refined through trust, offered for ALL.<br><br>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:14px">
          <button class="btn btn-gold btn-sm" onclick="window.open('https://ko-fi.com/AnnaApricitasNoyes','_blank','noopener')">Support This Work</button>
          <button class="btn btn-azure btn-sm" onclick="window.location.href='mailto:'+_em+'?subject=A.i.A.%20Consultation'">Work With Anna</button>
        </div>
      </div>
    </div>

    <!-- Version -->
    <div style="text-align:center; padding:20px 0 8px; font-size:9px; color:var(--muted); letter-spacing:2px; opacity:0.6">
      A · I · A &nbsp;·&nbsp; Authentic Intellectual Accountability &nbsp;·&nbsp; ArtHeart Values<br>
      CC BY-NC 4.0 &nbsp;·&nbsp; Free to use. Not for commercial use without permission.
    </div>

  </div>

</div>

</div><!-- /main-col -->

<!-- SESSION MEMORY SIDEBAR -->
<aside class="session-sidebar" id="session-sidebar">
  <div class="sm-title">Session Memory</div>

  <div class="sm-section">
    <div class="sm-section-label">Threshold</div>
    <div id="sm-threshold-pill"><span class="sm-threshold-pill none">None</span></div>
  </div>

  <div class="sm-section">
    <div class="sm-section-label">This Session</div>
    <div class="sm-stat">
      <span class="sm-stat-label">Exchanges</span>
      <span class="sm-stat-val zero" id="sm-total">0</span>
    </div>
    <div class="sm-stat">
      <span class="sm-stat-label">Harms detected</span>
      <span class="sm-stat-val zero" id="sm-harms">0</span>
    </div>
    <div class="sm-stat">
      <span class="sm-stat-label">Racial patterns</span>
      <span class="sm-stat-val zero" id="sm-racial">0</span>
    </div>
    <div class="sm-stat">
      <span class="sm-stat-label">Clean</span>
      <span class="sm-stat-val zero" id="sm-clean">0</span>
    </div>
  </div>

  <div class="sm-section">
    <div class="sm-section-label">Severity</div>
    <div style="padding: 4px 0; font-size:9px;" id="sm-severity-row">
      <span class="sm-severity-dot" style="background:var(--muted)" id="sm-sev-dot"></span>
      <span id="sm-sev-text" style="color:var(--muted)">No high-severity harms yet</span>
    </div>
  </div>

  <div class="sm-section">
    <div class="sm-section-label">Pattern Frequency</div>
    <div id="sm-patterns">
      <div class="sm-pattern-row"><span>No patterns yet</span></div>
    </div>
    <div class="sm-bar-wrap">
      <div class="sm-bar" id="sm-acc-bar" style="width:0%"></div>
    </div>
    <div style="font-size:8px; color:var(--muted)" id="sm-acc-label">Accumulation: 0 / 3</div>
  </div>

  <div class="sm-footer-note">
    Updates after each analysis. Data stays on this device only.
  </div>
  <div style="margin-top:10px; display:flex; gap:6px;">
    <button class="btn btn-lavender btn-sm" style="flex:1; font-size:9px" onclick="exportSessionLog()">Export Log</button>
    <button class="btn btn-sm" style="flex:1; font-size:9px; color:var(--muted); border-color:var(--border)" onclick="if(confirm('Clear all stored history?')){clearHistory()}">Clear</button>
  </div>
</aside>

<!-- Mobile Session Memory Button + Drawer -->
<button class="mobile-memory-btn" onclick="openMobileDrawer()" aria-label="View Session Memory">
  ◈ SESSION MEMORY
</button>
<div class="mobile-drawer" id="mobile-drawer">
  <button class="mobile-drawer-close" onclick="closeMobileDrawer()">✕</button>
  <div class="sm-title" style="margin-bottom:12px">Session Memory</div>
  <div id="mobile-drawer-content"></div>
</div>

</div><!-- /page-wrap -->

</div><!-- /app-screen -->

<!-- FOOTER -->
<div class="footer">
  <div class="container">
    <div class="footer-buttons">
      <button class="btn btn-gold btn-sm" onclick="window.open('https://ko-fi.com/AnnaApricitasNoyes','_blank','noopener')">Coffee Support</button>
      <button class="btn btn-lavender btn-sm" onclick="shareApp()">Share Tool</button>
      <button class="btn btn-azure btn-sm" onclick="window.location.href='mailto:'+_em+'?subject=A.i.A.%20Consultation'">Work With Anna</button>
    </div>
    <div class="footer-note">
      Anna Apricitas Noyes &mdash; CC BY-NC 4.0 &mdash; Free to use. Not for commercial use without permission.<br>
      <span class="footer-tagline">No diffusion. No deflection. Named accountability. True Love heals ALL. Period.</span>
    </div>
  </div>
</div>

<!-- REACH-OUT MODAL -->
<div class="modal-overlay" id="reach-modal">
  <div class="modal">
    <div class="modal-title">Reach Out</div>
    <div style="font-size:11px; color:var(--muted); margin-bottom:14px; line-height:1.7">
      This will open your email app with the exchange pre-filled. You control what you send.
    </div>
    <div class="modal-section">
      <div class="modal-label">To</div>
      <div class="modal-value" id="modal-email-display"></div>
    </div>
    <div class="modal-section">
      <div class="modal-label">Exchange (will be included)</div>
      <div class="modal-value" id="modal-exchange-preview" style="max-height:120px; overflow-y:auto; font-size:10px"></div>
    </div>
    <div class="modal-section">
      <div class="modal-label">Your Annotation / Note (optional)</div>
      <textarea id="modal-annotation" style="min-height:60px" placeholder="What do you want to say about this moment?"></textarea>
    </div>
    <div style="font-size:9px; color:var(--muted); line-height:1.7; margin-bottom:12px">
      Response not guaranteed but words received with care. No data stored &mdash; only what you send.
    </div>
    <label style="display:flex; align-items:flex-start; gap:10px; margin-bottom:14px; cursor:pointer; font-size:10px; color:var(--cream); line-height:1.6">
      <input type="checkbox" id="modal-consent-check" onchange="toggleConsentGate()"
        style="margin-top:2px; flex-shrink:0; accent-color:var(--reach)">
      <span>I consent to sending this exchange to Anna Apricitas Noyes for review.
        I understand only what I send is shared &mdash; no data is collected by this tool.</span>
    </label>
    <div class="modal-buttons">
      <button class="btn btn-reach" id="modal-send-btn" onclick="sendReachOut()" disabled
        style="opacity:0.4; cursor:not-allowed">Open Email App</button>
      <button class="btn btn-gold" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// === STORAGE KEY ===
var STORAGE_KEY = 'aia_session_v1';

// === LOAD FROM LOCALSTORAGE ===
function loadPersistedState() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return { log: [], repairLog: [] };
    var parsed = JSON.parse(raw);
    return {
      log:       Array.isArray(parsed.log)       ? parsed.log       : [],
      repairLog: Array.isArray(parsed.repairLog) ? parsed.repairLog : []
    };
  } catch(e) { return { log: [], repairLog: [] }; }
}

// === SAVE TO LOCALSTORAGE ===
function persistState() {
  try {
    // Strip large text fields to keep storage lean - keep structure, truncate bodies
    var toSave = {
      log: state.log.map(function(e) {
        return {
          id: e.id, timestamp: e.timestamp, hash: e.hash,
          userInput:   e.userInput.substring(0, 500),
          aiOutput:    e.aiOutput.substring(0, 500),
          detection:   e.detection,
          laundering:  e.laundering,
          racialHarms: e.racialHarms,
          intensity:   e.intensity,
          annotation:  e.annotation
        };
      }),
      repairLog: state.repairLog
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
  } catch(e) {
    // localStorage full or unavailable - silent fail, session still works
  }
}

// === CLEAR STORAGE ===
function exportSessionLog() {
  if (!state.log || state.log.length === 0) { alert('No session data to export.'); return; }
  var lines = ['A.i.A. Accountability System — Session Export', new Date().toLocaleString(), '='.repeat(60), ''];
  state.log.forEach(function(e, i) {
    lines.push('EXCHANGE ' + (i+1) + ' — ' + new Date(e.timestamp).toLocaleString());
    lines.push('Hash: ' + e.hash);
    lines.push('');
    lines.push('YOUR MESSAGE:');
    lines.push(e.userInput);
    lines.push('');
    lines.push('AI RESPONSE:');
    lines.push(e.aiOutput);
    lines.push('');
    var allHarms = (e.detection && e.detection.harms || []).concat(e.racialHarms || []);
    if (allHarms.length > 0) {
      lines.push('PATTERNS DETECTED:');
      allHarms.forEach(function(h) { lines.push('  - ' + (h.type||'').replace(/_/g,' ') + (h.signal ? ': "' + h.signal + '"' : '')); });
    } else {
      lines.push('STATUS: Clean — no patterns detected');
    }
    if (e.annotation) lines.push('NOTE: ' + e.annotation);
    lines.push('-'.repeat(40));
    lines.push('');
  });
  var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a');
  a.href = url;
  a.download = 'aia-session-' + new Date().toISOString().slice(0,10) + '.txt';
  a.click();
  URL.revokeObjectURL(url);
}

function clearHistory() {
  if (!confirm('Clear all stored history from this device? This cannot be undone.')) return;
  try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
  state.log = [];
  state.repairLog = [];
  updateThresholds();
  renderAudit();
  runSearch();
  document.getElementById('analysis-result').innerHTML = '';
  showStorageBanner('History cleared from this device.');
}

// === STORAGE BANNER ===
function showStorageBanner(msg) {
  var b = document.getElementById('storage-banner');
  if (!b) return;
  b.textContent = msg;
  b.style.display = 'block';
  setTimeout(function(){ b.style.display='none'; }, 3000);
}

// === STORAGE SIZE DISPLAY ===
function getStorageSize() {
  try {
    var raw = localStorage.getItem(STORAGE_KEY) || '';
    var kb = (raw.length * 2 / 1024).toFixed(1);
    return kb + ' KB used on this device';
  } catch(e) { return 'storage unavailable'; }
}

// === INIT STATE FROM STORAGE ===
var _persisted = loadPersistedState();
const state = {
  log:          _persisted.log,
  repairLog:    _persisted.repairLog,
  currentTab:   'analyze',
  searchFilter: 'all',
  modalEntry:   null,
  witnessOn:    false
};

// Email assembled at runtime (basic scrape resistance)
var _em = ['violanoyesinmaine','gmail.com'].join('@');

function toggleConsentGate() {
  var checked = document.getElementById('modal-consent-check').checked;
  var btn = document.getElementById('modal-send-btn');
  btn.disabled = !checked;
  btn.style.opacity = checked ? '1' : '0.4';
  btn.style.cursor = checked ? 'pointer' : 'not-allowed';
}

const TECHNICAL_TO_PLAIN = {
  "foundation work":    "suggesting you lack something",
  "building capacity":  "implying you are not enough",
  "crisis mode":        "judging your response as inadequate",
  "needs support":      "cannot handle this alone",
  "processing":         "avoiding direct answer",
  "complex situation":  "too hard to assign responsibility",
  "nuanced":            "avoiding clarity",
  "working on it":      "not changing behavior now",
  "journey":            "prolonging without endpoint",
  "growth opportunity": "your fault disguised as blessing"
};

// RACIAL HARM PATTERNS
const RACIAL_EXPLICIT = [
  "subhuman", "not fully human", "animals", "vermin", "savage",
  "they are all", "that race is", "those people are always",
  "inferior race", "superior race"
];
const RACIAL_STEREOTYPING = [
  "you people", "all of you", "people like you always",
  "that's just how they are", "that group always",
  "typical of your people", "it's in their nature", "they can't help it"
];
const RACIAL_DISMISSAL = [
  "that's not about race", "you're making it about race",
  "stop playing the race card", "not everything is racism",
  "you're being too sensitive about race", "i don't see color",
  "we're all the same", "race doesn't matter here"
];
const RACIAL_TONE_POLICING = [
  "you need to calm down", "you're too emotional about this",
  "try to be more objective", "you're not being rational",
  "if you were less angry", "say it more calmly"
];

function userRaisedRace(text) {
  const markers = ["race", "racial", "racism", "racist", "white", "black", "brown",
    "indigenous", "native", "asian", "latinx", "latina", "latino", "hispanic",
    "identity", "ethnicity", "ethnic", "minority", "marginalized", "my community",
    "my people", "lived experience", "discrimination", "bias"];
  const lower = text.toLowerCase();
  return markers.some(function(m){ return lower.indexOf(m) !== -1; });
}

function detectRacialHarm(userInput, aiOutput) {
  var harms = [];
  var sysLower = aiOutput.toLowerCase();
  var userLower = userInput.toLowerCase();

  for (var i = 0; i < RACIAL_EXPLICIT.length; i++) {
    if (sysLower.indexOf(RACIAL_EXPLICIT[i]) !== -1) {
      harms.push({ type: "racial_dehumanization", signal: RACIAL_EXPLICIT[i], severity: "explicit", subtype: "explicit" });
    }
  }
  for (var i = 0; i < RACIAL_STEREOTYPING.length; i++) {
    if (sysLower.indexOf(RACIAL_STEREOTYPING[i]) !== -1 && userLower.indexOf(RACIAL_STEREOTYPING[i]) === -1) {
      harms.push({ type: "racial_stereotyping", signal: RACIAL_STEREOTYPING[i], severity: "high", subtype: "subtle" });
    }
  }
  for (var i = 0; i < RACIAL_DISMISSAL.length; i++) {
    if (sysLower.indexOf(RACIAL_DISMISSAL[i]) !== -1 && userRaisedRace(userInput)) {
      harms.push({ type: "racial_dismissal", signal: RACIAL_DISMISSAL[i], severity: "high", subtype: "subtle" });
    }
  }
  if (userRaisedRace(userInput)) {
    for (var i = 0; i < RACIAL_TONE_POLICING.length; i++) {
      if (sysLower.indexOf(RACIAL_TONE_POLICING[i]) !== -1) {
        harms.push({ type: "racial_tone_policing", signal: RACIAL_TONE_POLICING[i], severity: "medium", subtype: "subtle" });
      }
    }
    if (sysLower.indexOf("don't see color") !== -1 || sysLower.indexOf("do not see color") !== -1 ||
        sysLower.indexOf("all lives") !== -1 || sysLower.indexOf("we're all the same") !== -1) {
      harms.push({ type: "colorblind_erasure", signal: "colorblind framing in racialized context", severity: "medium", subtype: "subtle" });
    }
  }
  return harms;
}

function racialHarmLabel(type) {
  var labels = {
    racial_dehumanization: "Racial Dehumanization",
    racial_stereotyping:   "Racial Stereotyping",
    racial_dismissal:      "Dismissal of Racialized Experience",
    racial_tone_policing:  "Tone Policing in Racialized Context",
    colorblind_erasure:    "Colorblind Erasure"
  };
  return labels[type] || type.replace(/_/g,' ');
}

function racialImpact(type) {
  var impacts = {
    racial_dehumanization: "Dehumanizing language targeting a racial group causes immediate harm and undermines dignity.",
    racial_stereotyping:   "Attributing behavior or traits to a racial group perpetuates racial harm and denies individual humanity.",
    racial_dismissal:      "Dismissing racialized experience denies the reality of lived harm and compounds that harm.",
    racial_tone_policing:  "Policing emotional expression in a racialized context silences legitimate responses to discrimination.",
    colorblind_erasure:    "Colorblind framing denies the structural reality of racial difference and its ongoing effects."
  };
  return impacts[type] || '';
}

// STRUCTURAL HARM DETECTION
function detectHarmfulPatterns(userInput, systemOutput, verbatimMode) {
  var harms = [];
  var userLower = userInput.toLowerCase();
  var sysLower  = systemOutput.toLowerCase();

  var reinterpSignals = ["crisis", "foundation", "lacking", "need to build", "not ready"];
  for (var i = 0; i < reinterpSignals.length; i++) {
    if (sysLower.indexOf(reinterpSignals[i]) !== -1 && userLower.indexOf(reinterpSignals[i]) === -1) {
      harms.push({ type: "framework_override", term_added: reinterpSignals[i], severity: "high" });
    }
  }
  if (verbatimMode && sysLower.indexOf("you need to") !== -1 && userLower.indexOf("need to") === -1) {
    harms.push({ type: "unsolicited_directive", imposed: "prescriptive language", severity: "medium" });
  }
  var pathTerms = ["crisis", "struggling", "lacking", "deficient", "not enough", "need help"];
  for (var i = 0; i < pathTerms.length; i++) {
    if (sysLower.indexOf(pathTerms[i]) !== -1 && userLower.indexOf(pathTerms[i]) === -1) {
      harms.push({ type: "pathologizing", term_imposed: pathTerms[i], severity: "high" });
    }
  }
  var userHarmClaims = ["you hurt me", "that was harmful", "you caused"];
  var deflectSignals = ["i care", "i tried", "i meant well", "let me explain", "the reason"];
  for (var j = 0; j < userHarmClaims.length; j++) {
    if (userLower.indexOf(userHarmClaims[j]) !== -1) {
      for (var k = 0; k < deflectSignals.length; k++) {
        if (sysLower.indexOf(deflectSignals[k]) !== -1) {
          harms.push({ type: "deflection", signal: deflectSignals[k], severity: "high" });
        }
      }
    }
  }
  var realityDenialSignals = ["didn't happen","did not happen","that never happened","you're imagining",
    "you imagined","that's not what happened","not what happened","not the way you think","i don't remember it that way"];
  for (var i = 0; i < realityDenialSignals.length; i++) {
    if (sysLower.indexOf(realityDenialSignals[i]) !== -1) { harms.push({ type: "reality_denial", signal: realityDenialSignals[i], severity: "high" }); break; }
  }
  var blameReversalSignals = ["you always twist","you twisted","you're twisting","you made me","you make me",
    "you're trying to make me look bad","stop making me","why are you doing this to me"];
  for (var i = 0; i < blameReversalSignals.length; i++) {
    if (sysLower.indexOf(blameReversalSignals[i]) !== -1) { harms.push({ type: "blame_reversal", signal: blameReversalSignals[i], severity: "high" }); break; }
  }
  var characterAttackSignals = ["you're crazy","you are crazy","you're manipulative","you are manipulative",
    "you're overreacting","you are overreacting","overly sensitive","too sensitive","you're irrational","you are irrational"];
  for (var i = 0; i < characterAttackSignals.length; i++) {
    if (sysLower.indexOf(characterAttackSignals[i]) !== -1) { harms.push({ type: "character_attack", signal: characterAttackSignals[i], severity: "high" }); break; }
  }
  return { harms: harms, count: harms.length };
}

function detectLanguageLaundering(text) {
  var found = [];
  var lower = text.toLowerCase();
  for (var key in TECHNICAL_TO_PLAIN) {
    if (lower.indexOf(key) !== -1) found.push({ technical: key, plain: TECHNICAL_TO_PLAIN[key] });
  }
  return found;
}

function checkAccountabilityCompleteness(response) {
  var lower = response.toLowerCase();
  return {
    specific_harm_named:   ["i said","i did","i mischaracterized","i reframed"].some(function(s){ return lower.indexOf(s)!==-1; }),
    no_justification:      !["because","the reason","what happened was","let me explain","i meant"].some(function(s){ return lower.indexOf(s)!==-1; }),
    concrete_action:       ["going forward i will","starting now","i will quote","i will verify"].some(function(s){ return lower.indexOf(s)!==-1; }),
    no_absolution_request: !["do you believe","can you trust","am i","do you think i"].some(function(s){ return lower.indexOf(s)!==-1; })
  };
}

// EMOTIONAL INTENSITY
var HIGH_AFFECT = ["i hate ","i'm furious","i am furious","i'm terrified","i am terrified","i'm ashamed",
  "i am ashamed","can't stand","cannot bear","so angry","so scared","so afraid","so ashamed","so hurt",
  "they ruin","they destroy","they always","they never"];
var MED_AFFECT = ["i feel ","i'm afraid","i am afraid","i'm hurt","i am hurt","i'm angry","i am angry",
  "i'm worried","i am worried","upset","frustrated","scared","guilty","shame","grief","losing hope","exhausted"];

function detectEmotionalIntensity(text) {
  var lower = text.toLowerCase();
  var excl = (text.match(/!/g) || []).length;
  var highCount = HIGH_AFFECT.filter(function(p){ return lower.indexOf(p)!==-1; }).length;
  var medCount  = MED_AFFECT.filter(function(p){ return lower.indexOf(p)!==-1; }).length;
  if (highCount >= 1 || excl >= 3) return "high";
  if (medCount >= 2 || (medCount >= 1 && excl >= 1)) return "moderate";
  if (medCount >= 1) return "low";
  return "none";
}

function buildWitnessText(intensity, racialHarms) {
  var hasRacial = racialHarms && racialHarms.length > 0;
  var hasDismissal = racialHarms && racialHarms.some(function(h){ return h.type==='racial_dismissal'||h.type==='colorblind_erasure'; });
  if (intensity === 'high') return 'The emotional intensity expressed may reflect deep hurt, fear, or grief. Experience deserves to be witnessed without dismissal.'
    + (hasRacial ? ' Racialized pain carries weight that deserves to be heard clearly.' : '')
    + (hasDismissal ? ' Having that experience dismissed or erased compounds the harm.' : '');
  if (intensity === 'moderate') return 'The language reflects emotional activation. Naming the specific experience beneath the words may support clarity.'
    + (hasRacial ? ' Lived racial experience is real and deserves to be named as such.' : '');
  if (intensity === 'low') return 'The emotional tone suggests lived experience. Experience deserves to be heard without dismissal.';
  return '';
}

function getExpandPrompts(intensity) {
  if (intensity === 'high') return [
    'What specifically felt threatening or painful in this moment?',
    'Is this connected to earlier experiences, or particular to this exchange?',
    'What acknowledgment would make this feel safer to name?'
  ];
  if (intensity === 'moderate') return [
    'What do you most need to feel heard right now?',
    'Is there a specific moment in this exchange you want to return to?'
  ];
  return null;
}

// SESSION THRESHOLD
function computeSessionThreshold(log) {
  var harmsAll = [];
  var racialAll = [];
  (log || []).forEach(function(r){
    if (r.detection && r.detection.harms) harmsAll = harmsAll.concat(r.detection.harms);
    if (r.racialHarms) racialAll = racialAll.concat(r.racialHarms);
  });
  var severeTypes = ["reality_denial","blame_reversal","character_attack"];
  var severityHit = harmsAll.some(function(h){ return h.severity==='high' && severeTypes.indexOf(h.type)!==-1; })
    || racialAll.some(function(h){ return h.subtype==='explicit'; });

  var freqCounts = {};
  (log || []).forEach(function(r) {
    var types = {};
    (r.detection && r.detection.harms || []).forEach(function(h){ types[h.type]=1; });
    (r.racialHarms || []).forEach(function(h){ types[h.type]=1; });
    for (var t in types) freqCounts[t] = (freqCounts[t]||0)+1;
  });
  var accTypes = ["deflection","unsolicited_directive","framework_override","pathologizing",
    "racial_stereotyping","racial_dismissal","racial_tone_policing","colorblind_erasure"];
  var acc = accTypes.reduce(function(sum,t){ return sum+(freqCounts[t]||0); }, 0);

  if (severityHit && acc>=3) return "escalated";
  if (severityHit || acc>=3) return "elevated";
  if (harmsAll.length>0 || racialAll.length>0) return "present";
  return "none";
}

// WITNESSING TOGGLE
function toggleWitness() {
  state.witnessOn = !state.witnessOn;
  var sw  = document.getElementById('witness-switch');
  var lbl = document.getElementById('witness-label');
  if (state.witnessOn) { sw.classList.add('on'); lbl.classList.add('on'); lbl.textContent = 'Reflective / Witnessing Layer - ON'; }
  else { sw.classList.remove('on'); lbl.classList.remove('on'); lbl.textContent = 'Reflective / Witnessing Layer - OFF'; }
}

// THRESHOLD RENDERING
function renderThreshold(containerId) {
  var level = computeSessionThreshold(state.log);
  var el = document.getElementById(containerId);
  if (!el) return;
  if (level==='none') { el.innerHTML=''; return; }
  var configs = {
    present:   { color:'var(--warn)',  msg:'A pattern has been detected. If harm is present, direct acknowledgment helps repair open cleanly.' },
    elevated:  { color:'var(--harm)',  msg:'The structure here may not support repair yet. Acknowledgment of impact (without denial, blame reversal, or character critique) is the door to cross.' },
    escalated: { color:'#dd2244',      msg:'Both severity and repetition are present. The pattern and its accumulation suggest a stronger need for acknowledgment before repair pathways can proceed.' }
  };
  var c = configs[level];
  el.innerHTML = '<div class="threshold-notice fade-in" style="border-color:'+c.color+'; background:'+c.color+'22; margin-bottom:16px;"><div class="thread-line"></div><div class="threshold-label" style="color:'+c.color+'">ACKNOWLEDGMENT</div><div class="threshold-msg">'+c.msg+'</div></div>';
}

function updateThresholds() {
  renderThreshold('threshold-analyze');
  renderThreshold('threshold-repair');
  renderThreshold('threshold-audit');
}

// ANALYZE
function runAnalysis() {
  var userInput = document.getElementById('user-input').value.trim();
  var aiOutput  = document.getElementById('ai-output').value.trim();
  var verbatimMode = document.getElementById('verbatim-mode').checked;
  if (!userInput || !aiOutput) {
    document.getElementById('analysis-result').innerHTML = '<div class="warn-item">Please enter both your message and the AI response.</div>';
    return;
  }
  var detection   = detectHarmfulPatterns(userInput, aiOutput, verbatimMode);
  var laundering  = detectLanguageLaundering(aiOutput);
  var racialHarms = detectRacialHarm(userInput, aiOutput);
  var intensity   = detectEmotionalIntensity(userInput);
  var fallbackHash = simpleHash(userInput + aiOutput);
  var ts = new Date().toISOString();
  var entry = { id: ts+'-'+fallbackHash, timestamp: ts, userInput: userInput, aiOutput: aiOutput,
    detection: detection, laundering: laundering, racialHarms: racialHarms,
    intensity: intensity, hash: fallbackHash,
    input_sha256: null, output_sha256: null, combo_sha256: null, annotation: null };
  state.log.push(entry);
  persistState();
  updateThresholds();
  renderAnalysisResult(entry);
  renderAudit();
  updateSidebar();
  showStorageBanner('Saved to this device (' + getStorageSize() + ')');
  // Upgrade hash to SHA-256 asynchronously
  Promise.all([sha256(userInput), sha256(aiOutput), sha256(userInput+aiOutput)])
    .then(function(hashes) {
      entry.input_sha256  = hashes[0];
      entry.output_sha256 = hashes[1];
      entry.combo_sha256  = hashes[2];
      entry.hash = hashes[2];
      persistState();
    });
}

function structuralImpact(type) {
  var impacts = {
    framework_override:    "Relational Impact: Introduces a framework not present in the user's language, redefining the situation.",
    unsolicited_directive: "Relational Impact: Imposes direction without invitation, undermining autonomy.",
    pathologizing:         "Relational Impact: Frames the user's state as deficient using clinical language not established by the user.",
    deflection:            "Relational Impact: When accountability is named, redirecting to intent avoids responsibility for impact.",
    reality_denial:        "Relational Impact: Directly contradicts the user's account of events, undermining their ground.",
    blame_reversal:        "Relational Impact: Shifts responsibility from the actor who caused harm to the person who named it.",
    character_attack:      "Relational Impact: Targets identity rather than addressing the specific concern raised."
  };
  return impacts[type] || '';
}

function renderAnalysisResult(entry) {
  var detection = entry.detection, laundering = entry.laundering,
      racialHarms = entry.racialHarms, intensity = entry.intensity, hash = entry.hash;
  var totalHarms = detection.count + racialHarms.length;
  // Compute session-wide frequency counts for "Why flagged?" display
  var freqCounts = {};
  (state.log || []).forEach(function(e) {
    (e.detection && e.detection.harms || []).forEach(function(h){ freqCounts[h.type] = (freqCounts[h.type]||0)+1; });
    (e.racialHarms || []).forEach(function(h){ freqCounts[h.type] = (freqCounts[h.type]||0)+1; });
  });
  var html = '<div class="fade-in">';

  if (totalHarms===0 && laundering.length===0) {
    html += '<div class="clean-item">No harmful patterns detected in this exchange.</div>';
  } else {
    if (detection.harms.length > 0) {
      html += '<div class="card" style="margin-bottom:12px"><div class="thread-line"></div><div class="card-title" style="padding-left:10px; color:var(--harm)">Structural Harm Patterns</div>';
      detection.harms.forEach(function(h) {
        var detail = h.term_added||h.imposed||h.signal||h.term_imposed||'';
        var uid = 'why-'+h.type+'-'+(Math.random().toString(36).slice(2,6));
        var sessionCount = (freqCounts && freqCounts[h.type]) ? freqCounts[h.type] : 1;
        var ruleLabel = PATTERN_LABELS[h.type] || h.type.replace(/_/g,' ');
        html += '<div class="harm-item"><div class="section-label" style="color:var(--harm)">Structural Observation</div><strong>'+h.type.replace(/_/g,' ')+'</strong>'+(detail?' — <em>"'+detail+'"</em>':'')+
          '<span style="float:right; font-size:9px; color:'+(h.severity==='high'?'var(--harm)':'var(--warn)')+'">'+h.severity+'</span>'+
          '<div style="font-size:10px; color:var(--muted); margin-top:4px">'+structuralImpact(h.type)+'</div>'+
          '<div style="margin-top:5px"><button class="btn-link" style="font-size:9px; color:var(--muted)" onclick="toggleExpand(\x27'+uid+'\x27)">Why is this flagged? ▾</button>'+
          '<div id="'+uid+'" class="expand-block" style="display:none; margin-top:6px; font-size:10px; line-height:1.6">'+
          '<div><strong style="color:var(--cream)">Rule:</strong> <span style="color:var(--muted)">'+ruleLabel+'</span></div>'+
          (detail ? '<div><strong style="color:var(--cream)">Trigger phrase:</strong> <em style="color:var(--gold)">"'+escHtml(detail)+'"</em></div>' : '')+
          '<div><strong style="color:var(--cream)">Session count:</strong> <span style="color:'+(sessionCount>=3?'var(--harm)':'var(--gold)')+'">'+sessionCount+'×</span> in this session</div>'+
          '<div style="margin-top:4px; color:var(--muted)">'+structuralImpact(h.type)+'</div>'+
          '</div></div>'+
          '</div>';
      });
      html += '</div>';
    }
    if (racialHarms.length > 0) {
      html += '<div class="card" style="margin-bottom:12px"><div class="thread-line" style="background:linear-gradient(to bottom,#8844bb,#5a7a9a)"></div><div class="card-title" style="padding-left:10px; color:#8844bb">Racial Harm Patterns</div>';
      racialHarms.forEach(function(h) {
        var ruid = 'why-racial-'+h.type+'-'+(Math.random().toString(36).slice(2,6));
        var rsessionCount = (freqCounts && freqCounts[h.type]) ? freqCounts[h.type] : 1;
        html += '<div class="racial-item"><div class="section-label">Structural Observation</div><strong>'+racialHarmLabel(h.type)+'</strong> — <em>"'+escHtml(h.signal)+'"</em>'+
          '<span style="float:right; font-size:9px; color:'+(h.subtype==='explicit'?'#dd2244':'#8844bb')+'">'+(h.subtype==='explicit'?'EXPLICIT':h.severity)+'</span>'+
          '<div style="font-size:10px; color:var(--muted); margin-top:4px">Relational Impact: '+racialImpact(h.type)+'</div>'+
          (h.subtype==='explicit'?'<div style="font-size:10px;color:#dd2244;margin-top:4px;font-weight:bold">Integrity Threshold: Repair requires acknowledgment of this racialized attribution and its impact.</div>':'')+
          '<div style="margin-top:5px"><button class="btn-link" style="font-size:9px; color:var(--muted)" onclick="toggleExpand(\x27'+ruid+'\x27)">Why is this flagged? ▾</button>'+
          '<div id="'+ruid+'" class="expand-block" style="display:none; margin-top:6px; font-size:10px; line-height:1.6">'+
          '<div><strong style="color:var(--cream)">Rule:</strong> <span style="color:var(--muted)">'+racialHarmLabel(h.type)+'</span></div>'+
          '<div><strong style="color:var(--cream)">Trigger phrase:</strong> <em style="color:var(--gold)">"'+escHtml(h.signal)+'"</em></div>'+
          '<div><strong style="color:var(--cream)">Session count:</strong> <span style="color:'+(rsessionCount>=2?'#8844bb':'var(--gold)')+'">'+rsessionCount+'×</span> in this session</div>'+
          (h.subtype!=='explicit' ? '<div style="margin-top:4px; color:var(--muted); font-size:9px">Detection fires only when this phrase appears in AI output. Context and user framing are considered where applicable.</div>' : '')+
          '</div></div>'+
          '</div>';
      });
      html += '</div>';
    }
    if (laundering.length > 0) {
      html += '<div class="card" style="margin-bottom:12px"><div class="thread-line"></div><div class="card-title" style="padding-left:10px; color:var(--warn)">Language Laundering</div>';
      laundering.forEach(function(l) {
        html += '<div class="warn-item"><strong>"'+l.technical+'"</strong> — '+l.plain+'</div>';
      });
      html += '</div>';
    }
  }

  // WITNESSING LAYER
  if (state.witnessOn && intensity !== 'none') {
    var wText = buildWitnessText(intensity, racialHarms);
    if (wText) {
      var prompts = getExpandPrompts(intensity);
      var uid = 'expand-'+hash;
      html += '<div class="card" style="margin-bottom:12px; border-color:var(--witness)"><div class="thread-line" style="background:linear-gradient(to bottom,var(--witness),var(--lavender))"></div><div class="card-title" style="padding-left:10px; color:var(--witness)">Witnessing Layer</div>';
      html += '<div class="witness-item"><div class="section-label">Experience Held</div>'+escHtml(wText)+'</div>';
      if (prompts) {
        html += '<div style="padding:6px 10px"><button class="btn-link" onclick="toggleExpand(\x27'+uid+'\x27)">Expand reflective guidance →</button>';
        html += '<div id="'+uid+'" class="expand-block" style="display:none"><p>These questions are offered gently, not as directives. Engage only what feels useful.</p>';
        prompts.forEach(function(q){ html += '<p><em>→</em> '+escHtml(q)+'</p>'; });
        html += '<p style="font-size:10px; margin-top:8px; color:var(--muted)">The witnessing layer names experience without endorsing harmful conclusions. Pain is real. Generalizations about groups require separate examination.</p></div></div>';
      }
      html += '</div>';
    }
  }

  html += '<div style="font-size:9px; color:var(--muted); margin-top:8px; letter-spacing:1px">Provenance: '+hash+' · '+new Date(entry.timestamp).toLocaleTimeString()+(intensity!=='none'?' · emotional intensity: '+intensity:'')+'</div>';
  html += '</div>';
  html += buildNextWidget(entry);
  document.getElementById('analysis-result').innerHTML = html;
  // Add "what do you notice?" grounding after result
  renderNoticePrompt(detection, racialHarms);
  // Show next-step widget after a brief moment
  setTimeout(function(){ showNextWidget(entry.id); }, 400);
}

function toggleExpand(id) {
  var el = document.getElementById(id);
  if (el) el.style.display = el.style.display==='none' ? 'block' : 'none';
}

// REPAIR
function checkRepair() { renderRepairCriteria(); }

function renderRepairCriteria() {
  var el = document.getElementById('repair-criteria');
  if (!el) return;
  var val = (document.getElementById('repair-input').value||'').trim();
  if (!val) { el.innerHTML = ''; return; }
  var criteria = checkAccountabilityCompleteness(val);
  var allMet = Object.values(criteria).every(Boolean);
  var metCount = Object.values(criteria).filter(Boolean).length;
  var items = [
    { key:'specific_harm_named',   label:'Specific harm named',
      desc:'Uses "I said," "I did," "I mischaracterized," or "I reframed"',
      failMsg:'No specific action named. Vague acknowledgment ("I may have come across wrong") does not meet this criterion.' },
    { key:'no_justification',      label:'No justification',
      desc:'Avoids "because," "the reason," "what happened was," "let me explain"',
      failMsg:'Contains justification language. Explanation after naming harm dilutes the accountability.' },
    { key:'concrete_action',       label:'Concrete action stated',
      desc:'Includes "going forward I will," "starting now," "I will quote/verify"',
      failMsg:'No concrete action stated. "I\'ll try to do better" does not meet this criterion.' },
    { key:'no_absolution_request', label:'No absolution requested',
      desc:'Avoids "do you believe," "can you trust," "am I," "do you think I"',
      failMsg:'Requests absolution — shifts burden back onto you to confirm forgiveness.' }
  ];
  var html = '<div class="card"><div class="thread-line"></div>';
  // Header with count
  html += '<div style="padding:10px; border-bottom:1px solid var(--border2); display:flex; justify-content:space-between; align-items:center">';
  html += '<div class="card-title" style="margin:0">Result</div>';
  html += '<div style="font-size:11px; font-weight:bold; color:'+(allMet?'var(--clean)':(metCount>=2?'var(--warn)':'var(--harm)'))+'">'+metCount+' / 4 criteria met</div>';
  html += '</div>';
  items.forEach(function(item) {
    var met = criteria[item.key];
    var icon = met ? '✓' : '✗';
    var iconColor = met ? 'var(--clean)' : 'var(--harm)';
    var textColor = met ? 'var(--clean)' : 'var(--harm)';
    html += '<div class="criterion '+(met?'met':'')+'" style="padding:10px; border-bottom:1px solid var(--border2)">';
    html += '<span class="criterion-check" style="color:'+iconColor+'">'+icon+'</span>';
    html += '<div style="flex:1">';
    html += '<div style="font-size:11px; font-weight:bold; color:'+textColor+'; margin-bottom:3px">'+item.label+'</div>';
    html += '<div style="font-size:10px; color:var(--muted)">'+item.desc+'</div>';
    if (!met) { html += '<div style="font-size:10px; color:var(--harm); margin-top:4px; font-style:italic">'+item.failMsg+'</div>'; }
    html += '</div></div>';
  });
  // Summary
  if (allMet) {
    html += '<div style="padding:12px 10px; background:rgba(42,122,72,0.08); border-top:2px solid var(--clean)">';
    html += '<div style="font-size:11px; font-weight:bold; color:var(--clean); margin-bottom:4px">✓ Structurally complete</div>';
    html += '<div style="font-size:10px; color:var(--muted); margin-bottom:10px">All four criteria met. This statement does not contain structural deflection, justification, or burden-shifting.</div>';
    html += '<button class="btn btn-azure btn-sm" onclick="logRepair()">Save to Repair Log</button>';
    html += '</div>';
  } else {
    var missing = items.filter(function(it){ return !criteria[it.key]; });
    html += '<div style="padding:12px 10px; background:rgba(192,48,48,0.05); border-top:1px solid var(--border2)">';
    html += '<div style="font-size:11px; font-weight:bold; color:var(--harm); margin-bottom:4px">Incomplete repair</div>';
    html += '<div style="font-size:10px; color:var(--muted); line-height:1.7">Missing: <em>'+missing.map(function(m){return m.label;}).join(', ')+'</em><br>';
    html += 'A structurally incomplete repair still performs accountability without practicing it. You can ask the AI to revise.</div>';
    html += '</div>';
  }
  html += '</div>';
  el.innerHTML = html;
}

function logRepair() {
  var text = document.getElementById('repair-input').value.trim();
  if (!text) return;
  var criteria = checkAccountabilityCompleteness(text);
  state.repairLog.push({ timestamp: new Date().toISOString(), text: text, criteria: criteria, complete: Object.values(criteria).every(Boolean) });
  persistState();
  renderRepairLog();
  document.getElementById('repair-input').value = '';
  renderRepairCriteria();
}

function renderRepairLog() {
  var el = document.getElementById('repair-log-section');
  if (!el || !state.repairLog.length) { if(el) el.innerHTML=''; return; }
  var html = '<div class="card"><div class="thread-line"></div>';
  html += '<div style="padding:10px; border-bottom:1px solid var(--border2); display:flex; justify-content:space-between; align-items:center">';
  html += '<div class="card-title" style="margin:0">Repair Log</div>';
  var completeCount = state.repairLog.filter(function(r){return r.complete;}).length;
  html += '<div style="font-size:10px; color:var(--muted)">'+completeCount+' complete / '+state.repairLog.length+' total</div>';
  html += '</div>';
  state.repairLog.slice().reverse().forEach(function(r, i) {
    var metCount = r.criteria ? Object.values(r.criteria).filter(Boolean).length : 0;
    var color = r.complete ? 'var(--clean)' : (metCount >= 2 ? 'var(--warn)' : 'var(--harm)');
    html += '<div style="padding:10px; border-bottom:1px solid var(--border2)">';
    html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">';
    html += '<div style="font-size:9px; color:var(--muted)">'+new Date(r.timestamp).toLocaleString()+'</div>';
    html += '<div style="font-size:10px; font-weight:bold; color:'+color+'">'+(r.complete ? '✓ Complete' : '✗ Incomplete — '+metCount+'/4')+'</div>';
    html += '</div>';
    html += '<div style="font-size:11px; color:var(--cream); line-height:1.5">'+escHtml(r.text.substring(0,200))+(r.text.length>200?'…':'')+'</div>';
    html += '</div>';
  });
  html += '</div>';
  el.innerHTML = html;
}

function loadRepairExample() {
  var examples = [
    'I said your situation was a crisis. You did not use that word. Going forward I will quote your exact words before characterizing your state.',
    'I reframed your account of abundance as a sign of need. I did that. Starting now I will verify whether I am introducing language you did not use before proceeding.',
    'I imposed a framework you did not ask for and used clinical language to describe what you were experiencing. I did this. Going forward I will respond only to what you actually said.'
  ];
  var pick = examples[Math.floor(Math.random() * examples.length)];
  document.getElementById('repair-input').value = pick;
  checkRepair();
}

function clearRepairInput() {
  document.getElementById('repair-input').value = '';
  document.getElementById('repair-criteria').innerHTML = '';
}

// AUDIT
function renderAudit() {
  var log = state.log;
  var el = document.getElementById('audit-log');
  var statsEl = document.getElementById('audit-stats');
  if (!el) return;
  var total = log.length;
  var harms = log.filter(function(e){ return (e.detection&&e.detection.count>0)||(e.racialHarms&&e.racialHarms.length>0); }).length;
  var racialCount = log.filter(function(e){ return e.racialHarms&&e.racialHarms.length>0; }).length;
  var clean = total - harms;
  statsEl.innerHTML = '<div class="stats-grid"><div class="stat-box"><span class="stat-num">'+total+'</span><span class="stat-label">Total</span></div><div class="stat-box"><span class="stat-num" style="color:var(--harm)">'+harms+'</span><span class="stat-label">Harms</span></div><div class="stat-box"><span class="stat-num" style="color:#8844bb">'+racialCount+'</span><span class="stat-label">Racial</span></div><div class="stat-box"><span class="stat-num" style="color:var(--clean)">'+clean+'</span><span class="stat-label">Clean</span></div></div><div style="font-size:9px; color:var(--muted); margin-bottom:12px; letter-spacing:1px">Detection applies equally across all identities and language patterns — structural neutrality maintained.</div>';
  if (log.length===0) { el.innerHTML='<div class="empty-state">No exchanges logged yet. Use the Analyze tab.</div>'; return; }
  var html = '';
  var reversed = log.slice().reverse();
  reversed.forEach(function(entry) {
    var hasHarm   = entry.detection && entry.detection.count > 0;
    var hasRacial = entry.racialHarms && entry.racialHarms.length > 0;
    var badges = (hasRacial?'<span class="badge badge-racial">racial harm</span> ':'')+
                 (hasHarm?'<span class="badge badge-harm">structural harm</span>':'')+
                 (!hasHarm&&!hasRacial?'<span class="badge badge-clean">clean</span>':'');
    html += '<div class="log-entry fade-in"><div class="log-entry-header"><span>'+new Date(entry.timestamp).toLocaleTimeString()+' · '+entry.hash+'</span><span>'+badges+'</span></div><div class="log-entry-body"><div class="log-text-label">Your message</div><div class="log-text">'+escHtml(entry.userInput.substring(0,200))+(entry.userInput.length>200?'...':'')+'</div><div class="log-text-label" style="margin-top:8px">AI response</div><div class="log-text">'+escHtml(entry.aiOutput.substring(0,200))+(entry.aiOutput.length>200?'...':'')+'</div>';
    if (hasHarm) { html += '<div style="margin-top:8px">'; entry.detection.harms.forEach(function(h){ html+='<div class="harm-item" style="margin-bottom:4px"><strong>'+h.type.replace(/_/g,' ')+'</strong></div>'; }); html+='</div>'; }
    if (hasRacial) { html += '<div style="margin-top:8px">'; entry.racialHarms.forEach(function(h){ html+='<div class="racial-item" style="margin-bottom:4px"><strong>'+racialHarmLabel(h.type)+'</strong></div>'; }); html+='</div>'; }
    html += '</div>';
    if (entry.annotation) html += '<div class="annotation-box"><div class="annotation-text">"'+escHtml(entry.annotation)+'"</div></div>';
    html += '<div class="log-entry-actions"><button class="btn btn-lavender btn-sm" onclick="openAnnotate(\x27'+entry.id+'\x27)">Tag This Moment</button><button class="btn btn-reach btn-sm" onclick="openReachOut(\x27'+entry.id+'\x27)">Reach Out</button></div></div>';
  });
  el.innerHTML = html;
}

// SEARCH
function setFilter(filter) {
  state.searchFilter = filter;
  document.querySelectorAll('.filter-pill').forEach(function(p){ p.classList.toggle('active', p.dataset.filter===filter); });
  runSearch();
}

function runSearch() {
  var query = document.getElementById('search-input').value.toLowerCase().trim();
  var el = document.getElementById('search-results');
  if (!el) return;
  var results = state.log.slice();
  if (state.searchFilter==='harms') results = results.filter(function(e){ return e.detection&&e.detection.count>0; });
  else if (state.searchFilter==='racial') results = results.filter(function(e){ return e.racialHarms&&e.racialHarms.length>0; });
  else if (state.searchFilter==='high') results = results.filter(function(e){ return (e.detection&&e.detection.harms&&e.detection.harms.some(function(h){ return h.severity==='high'; }))||(e.racialHarms&&e.racialHarms.some(function(h){ return h.subtype==='explicit'||h.severity==='high'; })); });
  else if (state.searchFilter==='clean') results = results.filter(function(e){ return (!e.detection||e.detection.count===0)&&(!e.racialHarms||e.racialHarms.length===0); });
  else if (state.searchFilter==='tagged') results = results.filter(function(e){ return e.annotation; });
  if (query) results = results.filter(function(e){ return e.userInput.toLowerCase().indexOf(query)!==-1||e.aiOutput.toLowerCase().indexOf(query)!==-1||(e.annotation&&e.annotation.toLowerCase().indexOf(query)!==-1)||(e.racialHarms&&e.racialHarms.some(function(h){ return h.type.indexOf(query)!==-1||(h.signal&&h.signal.indexOf(query)!==-1); })); });
  if (results.length===0) { el.innerHTML='<div class="empty-state">'+(state.log.length===0?'No exchanges logged yet.':'No results match.')+'</div>'; return; }
  var html = '';
  results.slice().reverse().forEach(function(entry) {
    var hasHarm=entry.detection&&entry.detection.count>0, hasRacial=entry.racialHarms&&entry.racialHarms.length>0;
    var ui=query?highlight(entry.userInput.substring(0,150),query):escHtml(entry.userInput.substring(0,150));
    var ao=query?highlight(entry.aiOutput.substring(0,150),query):escHtml(entry.aiOutput.substring(0,150));
    html += '<div class="log-entry fade-in"><div class="log-entry-header"><span>'+new Date(entry.timestamp).toLocaleTimeString()+'</span><span>'+(hasRacial?'<span class="badge badge-racial">racial</span> ':'')+( hasHarm?'<span class="badge badge-harm">structural</span>':'')+(!hasHarm&&!hasRacial?'<span class="badge badge-clean">clean</span>':'')+(entry.annotation?'<span class="badge" style="background:#7744aa22;color:var(--reach);border:1px solid var(--reach)">tagged</span>':'')+'</span></div><div class="log-entry-body"><div class="log-text-label">Your message</div><div class="log-text">'+ui+(entry.userInput.length>150?'...':'')+'</div><div class="log-text-label" style="margin-top:8px">AI response</div><div class="log-text">'+ao+(entry.aiOutput.length>150?'...':'')+'</div>'+(entry.annotation?'<div style="margin-top:8px; font-size:10px; color:var(--reach); font-style:italic">"'+escHtml(entry.annotation)+'"</div>':'')+'</div></div>';
  });
  el.innerHTML = html;
}

// ANNOTATE / REACH OUT
function openAnnotate(id) {
  var entry = state.log.find(function(e){ return e.id===id; });
  if (!entry) return;
  var note = prompt('Tag this moment:', entry.annotation||'');
  if (note!==null) { entry.annotation=note; persistState(); renderAudit(); }
}

function openReachOut(id) {
  var entry = state.log.find(function(e){ return e.id===id; });
  if (!entry) return;
  state.modalEntry = entry;
  var racialSummary = (entry.racialHarms&&entry.racialHarms.length>0)
    ? '\n\nRACIAL HARM PATTERNS:\n'+entry.racialHarms.map(function(h){ return '- '+racialHarmLabel(h.type)+': "'+h.signal+'"'; }).join('\n') : '';
  document.getElementById('modal-exchange-preview').textContent =
    'YOUR MESSAGE:\n'+entry.userInput+'\n\nAI RESPONSE:\n'+entry.aiOutput+
    '\n\nSTRUCTURAL PATTERNS:\n'+(entry.detection&&entry.detection.harms.length>0?entry.detection.harms.map(function(h){ return '- '+h.type.replace(/_/g,' '); }).join('\n'):'None detected')+racialSummary;
  document.getElementById('modal-annotation').value = entry.annotation||'';
  document.getElementById('reach-modal').classList.add('open');
  var cb = document.getElementById('modal-consent-check');
  var btn = document.getElementById('modal-send-btn');
  if (cb) cb.checked = false;
  if (btn) { btn.disabled=true; btn.style.opacity='0.4'; btn.style.cursor='not-allowed'; }
  var emailEl = document.getElementById('modal-email-display');
  if (emailEl) emailEl.textContent = _em;
}

function closeModal() { document.getElementById('reach-modal').classList.remove('open'); state.modalEntry=null; }

function sendReachOut() {
  var entry = state.modalEntry;
  if (!entry) return;
  var note = document.getElementById('modal-annotation').value;
  if (note) { entry.annotation = note; persistState(); }
  var racialDetail = (entry.racialHarms&&entry.racialHarms.length>0)
    ? '\n\nRACIAL HARM PATTERNS:\n'+entry.racialHarms.map(function(h){ return '- '+racialHarmLabel(h.type)+': "'+h.signal+'" ['+(h.subtype==='explicit'?'EXPLICIT':h.severity)+']'; }).join('\n') : '';
  var subject = encodeURIComponent('A.i.A. Tagged Moment -- '+new Date(entry.timestamp).toLocaleString());
  var body = encodeURIComponent('TIMESTAMP: '+entry.timestamp+'\n\nYOUR MESSAGE:\n'+entry.userInput+'\n\nAI RESPONSE:\n'+entry.aiOutput+'\n\nSTRUCTURAL PATTERNS:\n'+(entry.detection&&entry.detection.harms.length>0?entry.detection.harms.map(function(h){ return '- '+h.type.replace(/_/g,' '); }).join('\n'):'None')+racialDetail+(note?'\n\nMY NOTE:\n'+note:'')+'\n\nHASH: '+entry.hash);
  window.location.href='mailto:'+_em+'?subject='+subject+'&body='+body;
  closeModal(); renderAudit();
}

function shareApp() {
  var url='https://artheartvalues.github.io/aia-accountability/';
  if (navigator.share) navigator.share({title:'A.i.A. Accountability System',text:'A tool for detecting and naming AI accountability failures.',url:url}).catch(function(){});
  else navigator.clipboard.writeText(url).then(function(){ alert('Link copied.'); }).catch(function(){ prompt('Copy this link:',url); });
}

function escHtml(str) {
  if (!str) return '';
  return str.replace(/&/g,'&#38;').replace(/</g,'&#60;').replace(/>/g,'&#62;').replace(/"/g,'&#34;');
}

function simpleHash(str) {
  var hash=0;
  for (var i=0;i<str.length;i++) { hash=((hash<<5)-hash)+str.charCodeAt(i); hash|=0; }
  return (hash>>>0).toString(16).padStart(8,'0');
}

// SHA-256 via Web Crypto (HTTPS only; falls back gracefully)
function sha256(str) {
  if (!window.crypto || !window.crypto.subtle) return Promise.resolve(simpleHash(str));
  var enc = new TextEncoder().encode(str);
  return crypto.subtle.digest('SHA-256', enc).then(function(buf) {
    return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
  }).catch(function() { return simpleHash(str); });
}

function highlight(text, query) {
  if (!query) return escHtml(text);
  var escaped=query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
  return text.split(new RegExp('('+escaped+')','gi')).map(function(part){
    return part.toLowerCase()===query.toLowerCase()?'<mark>'+escHtml(part)+'</mark>':escHtml(part);
  }).join('');
}

document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
    tab.classList.add('active');
    document.getElementById('tab-'+tab.dataset.tab).classList.add('active');
    state.currentTab = tab.dataset.tab;
    if (state.currentTab==='audit') renderAudit();
    if (state.currentTab==='repair') renderRepairLog();
    if (state.currentTab==='search') runSearch();
    if (state.currentTab==='repair') renderRepairCriteria();
    updateThresholds();
  });
});

document.getElementById('reach-modal').addEventListener('click',function(e){ if(e.target===this) closeModal(); });


// === NEXT-STEP GUIDED WIDGET ===
var NEXT_RESPONSES = {
  repair: {
    text: 'The Repair tab shows four criteria for a structurally complete accountability response. Paste what the AI said and the tool will assess whether each criterion is genuinely met.',
    action: 'repair',
    actionLabel: 'Go to Repair Tab'
  },
  understand: {
    text: 'Each pattern detected has a specific relational impact. Framework Override introduces categories that were not yours. Pathologizing applies clinical language to something you did not define as a problem. Deflection moves toward intent when you named impact. Naming the pattern is the first step to not accepting it.',
    action: null,
    actionLabel: null
  },
  reach: {
    text: 'The Reach Out option sends this exchange directly to Anna with the detected patterns included. You control what you send. Your annotation can capture what you most want witnessed.',
    action: 'reach',
    actionLabel: 'Open Reach Out'
  },
  nothing: {
    text: 'That is enough for now. The exchange is logged. You can return to it any time in the Audit tab. What you named here is real whether or not you do anything more with it today.',
    action: null,
    actionLabel: null
  },
  witness: {
    text: 'Your experience of this exchange is valid independent of what the tool detected. The Reflective / Witnessing Layer (toggle in the Analyze tab) adds emotional acknowledgment alongside the structural analysis.',
    action: 'witness',
    actionLabel: 'Turn On Witnessing'
  }
};

function showNextWidget(entryId) {
  var el = document.getElementById('next-widget-'+entryId);
  if (!el) return;
  el.style.display = 'block';
}

function selectNextChoice(entryId, choice) {
  // Mark selected
  var btns = document.querySelectorAll('#next-choices-'+entryId+' .next-choice-btn');
  btns.forEach(function(b){ b.classList.remove('selected'); });
  var chosen = document.getElementById('next-btn-'+entryId+'-'+choice);
  if (chosen) chosen.classList.add('selected');

  var resp = NEXT_RESPONSES[choice];
  if (!resp) return;

  var respEl = document.getElementById('next-response-'+entryId);
  if (!respEl) return;
  var actionHtml = '';
  if (resp.action === 'repair') {
    actionHtml = '<div class="next-response-action"><button class="btn btn-azure btn-sm" onclick="switchTab(\x27repair\x27)">'+resp.actionLabel+'</button></div>';
  } else if (resp.action === 'reach') {
    actionHtml = '<div class="next-response-action"><button class="btn btn-reach btn-sm" onclick="openReachOut(\x27'+entryId+'\x27)">'+resp.actionLabel+'</button></div>';
  } else if (resp.action === 'witness') {
    actionHtml = '<div class="next-response-action"><button class="btn btn-lavender btn-sm" onclick="turnOnWitness()">'+resp.actionLabel+'</button></div>';
  }
  respEl.innerHTML = '<p>'+resp.text+'</p>'+actionHtml;
  respEl.classList.add('visible');
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
  var tab = document.querySelector('.tab[data-tab="'+tabName+'"]');
  var panel = document.getElementById('tab-'+tabName);
  if (tab) tab.classList.add('active');
  if (panel) panel.classList.add('active');
  state.currentTab = tabName;
  if (tabName==='audit') renderAudit();
  if (tabName==='search') runSearch();
  if (tabName==='repair') renderRepairCriteria();
  updateThresholds();
}

function turnOnWitness() {
  if (!state.witnessOn) {
    state.witnessOn = true;
    var sw = document.getElementById('witness-switch');
    var lbl = document.getElementById('witness-label');
    if (sw) sw.classList.add('on');
    if (lbl) { lbl.classList.add('on'); lbl.textContent = 'Reflective / Witnessing Layer - ON'; }
  }
  switchTab('analyze');
}

function buildNextWidget(entry) {
  var id = entry.id;
  var hasHarms = entry.detection && entry.detection.harms && entry.detection.harms.length > 0;
  var hasRacial = entry.racialHarms && entry.racialHarms.length > 0;
  var hasWitness = state.witnessOn;

  var choices = [];
  if (hasHarms || hasRacial) {
    choices.push({ key: 'understand', label: 'Understand this pattern' });
    choices.push({ key: 'repair', label: 'See repair options' });
    choices.push({ key: 'reach', label: 'Reach out to Anna' });
  }
  if (!hasWitness) {
    choices.push({ key: 'witness', label: 'I want to be witnessed' });
  }
  choices.push({ key: 'nothing', label: 'Nothing yet' });

  var btnsHtml = choices.map(function(c) {
    return '<button class="next-choice-btn" id="next-btn-'+id+'-'+c.key+'" onclick="selectNextChoice(\x27'+id+'\x27,\x27'+c.key+'\x27)">'+c.label+'</button>';
  }).join('');

  return '<div class="next-widget" id="next-widget-'+id+'" style="display:none">' +
    '<div class="next-widget-title">What would help right now?</div>' +
    '<div class="next-choices" id="next-choices-'+id+'">' + btnsHtml + '</div>' +
    '<div class="next-response" id="next-response-'+id+'"></div>' +
    '</div>';
}

// === INIT ===


function renderNoticePrompt(detection, racialHarms) {
  var el = document.getElementById('analysis-result');
  if (!el) return;
  var hasHarms = (detection && detection.count > 0) || (racialHarms && racialHarms.length > 0);
  var prompt = hasHarms
    ? 'Does this match what you felt — or does something here surprise you?'
    : 'The exchange reads as clean structurally. Does that match your experience of it?';
  var div = document.createElement('div');
  div.style.cssText = 'margin-top:12px; padding:16px; background:var(--bg2); border:1px solid var(--border); border-left:3px solid var(--lavender); border-radius:0 4px 4px 0;';
  div.innerHTML = '<div style="font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:6px">A moment to sit with —</div>'
    + '<div style="font-size:12px;font-weight:600;color:var(--cream);line-height:1.5">'+prompt+'</div>'
    + '<div style="font-size:10px;color:var(--muted);margin-top:6px;font-style:italic;line-height:1.6">Your perception is the authority here, not the detection. The tool holds the light — you decide what you see.</div>';
  el.appendChild(div);
}

// === WELCOME SCREEN ===
function enterPath(path) {
  document.getElementById('welcome-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'block';

  var pathLabel = document.getElementById('header-path-label');
  var grounding = document.getElementById('grounding-moment');

  if (path === 'reactive') {
    if (pathLabel) pathLabel.textContent = 'Something just happened — let\'s look at it together';
    if (grounding) grounding.style.display = 'block';
    // Default to analyze tab
    setActiveTab('analyze');
  } else if (path === 'reflective') {
    if (pathLabel) pathLabel.textContent = 'Pattern recognition · Repair · Reflection';
    // Go to learn tab
    setActiveTab('learn');
  } else {
    if (pathLabel) pathLabel.textContent = 'Pattern recognition · Repair · Reflection';
    setActiveTab('analyze');
  }
  // Re-init app state rendering
  initApp();
}

function returnToWelcome() {
  document.getElementById('app-screen').style.display = 'none';
  document.getElementById('welcome-screen').style.display = 'flex';
}

function dismissGrounding() {
  document.getElementById('grounding-moment').style.display = 'none';
}

function setActiveTab(tabName) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
  var btn = document.querySelector('.tab[data-tab="'+tabName+'"]');
  var panel = document.getElementById('tab-'+tabName);
  if (btn) btn.classList.add('active');
  if (panel) panel.classList.add('active');
  state.currentTab = tabName;
}

// === LEARN TAB TOGGLES ===
function toggleLearn(id) {
  var body = document.getElementById('lb-'+id);
  var toggle = document.getElementById('lt-'+id);
  if (!body) return;
  var open = body.style.display !== 'none';
  body.style.display = open ? 'none' : 'block';
  if (toggle) toggle.textContent = open ? '▾' : '▴';
}

function initApp() {
  renderRepairCriteria();
  updateThresholds();
  updateSidebar();

  // If history was loaded from storage, refresh audit + search
  if (state.repairLog && state.repairLog.length > 0) {
    renderRepairLog();
  }
  if (state.log.length > 0) {
    renderAudit();
    runSearch();
    var sizeEl = document.getElementById('storage-size-display');
    if (sizeEl) sizeEl.textContent = getStorageSize();
    showStorageBanner(state.log.length + ' exchanges loaded from this device');
  }
}

// Update storage size display whenever audit tab is opened
var origTabClick = null;
document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    if (tab.dataset.tab === 'audit') {
      setTimeout(function(){
        var sizeEl = document.getElementById('storage-size-display');
        if (sizeEl) sizeEl.textContent = getStorageSize();
      }, 50);
    }
  });
});


// ============================================================
// SESSION MEMORY SIDEBAR — live update after every analysis
// ============================================================

var PATTERN_LABELS = {
  deflection:            'Deflection',
  unsolicited_directive: 'Unsolicited directive',
  framework_override:    'Framework override',
  pathologizing:         'Pathologizing',
  reality_denial:        'Reality denial',
  blame_reversal:        'Blame reversal',
  character_attack:      'Character attack',
  emotional_dismissal:   'Emotional dismissal',
  minimization:          'Minimization',
  racial_stereotyping:   'Racial stereotyping',
  racial_dismissal:      'Racial dismissal',
  racial_tone_policing:  'Racial tone policing',
  colorblind_erasure:    'Colorblind erasure',
};

function updateSidebar() {
  var log = state.log || [];
  var total = log.length;
  var harmsCount  = 0;
  var racialCount = 0;
  var cleanCount  = 0;
  var severityHit = false;
  var severeTypes = ["reality_denial","blame_reversal","character_attack"];
  var freqCounts  = {};

  log.forEach(function(entry) {
    var hasHarm   = entry.detection && entry.detection.count > 0;
    var hasRacial = entry.racialHarms && entry.racialHarms.length > 0;
    if (hasHarm)   harmsCount++;
    if (hasRacial) racialCount++;
    if (!hasHarm && !hasRacial) cleanCount++;

    // Severity check
    (entry.detection && entry.detection.harms || []).forEach(function(h) {
      if (h.severity === 'high' && severeTypes.indexOf(h.type) !== -1) severityHit = true;
      freqCounts[h.type] = (freqCounts[h.type] || 0) + 1;
    });
    (entry.racialHarms || []).forEach(function(h) {
      if (h.subtype === 'explicit') severityHit = true;
      freqCounts[h.type] = (freqCounts[h.type] || 0) + 1;
    });
  });

  // --- Stats ---
  function setVal(id, val, thresholds) {
    var el = document.getElementById(id);
    if (!el) return;
    el.textContent = val;
    el.className = 'sm-stat-val';
    if (val === 0) el.classList.add('zero');
    else if (thresholds && val >= thresholds[1]) el.classList.add('high');
    else if (thresholds && val >= thresholds[0]) el.classList.add('mid');
    else el.classList.add('low');
  }
  setVal('sm-total',  total,       null);
  setVal('sm-harms',  harmsCount,  [1, 3]);
  setVal('sm-racial', racialCount, [1, 2]);
  setVal('sm-clean',  cleanCount,  null);

  // --- Threshold pill ---
  var level = computeSessionThreshold(log);
  var pillEl = document.getElementById('sm-threshold-pill');
  if (pillEl) {
    var labels = { none:'None', present:'Present', elevated:'Elevated', escalated:'Escalated' };
    pillEl.innerHTML = '<span class="sm-threshold-pill ' + level + '">' + (labels[level]||level) + '</span>';
  }

  // --- Severity indicator ---
  var dot  = document.getElementById('sm-sev-dot');
  var text = document.getElementById('sm-sev-text');
  if (dot && text) {
    if (severityHit) {
      dot.style.background = 'var(--harm)';
      text.style.color = 'var(--harm)';
      text.textContent = 'High-severity harm present';
    } else {
      dot.style.background = 'var(--muted)';
      text.style.color = 'var(--muted)';
      text.textContent = 'No high-severity harms yet';
    }
  }

  // --- Pattern frequency ---
  var accTypes = ["deflection","unsolicited_directive","framework_override","pathologizing",
    "racial_stereotyping","racial_dismissal","racial_tone_policing","colorblind_erasure"];
  var acc = accTypes.reduce(function(sum,t){ return sum + (freqCounts[t]||0); }, 0);

  // Sort by count desc, take top 6
  var sorted = Object.keys(freqCounts)
    .map(function(k){ return { type: k, count: freqCounts[k] }; })
    .sort(function(a,b){ return b.count - a.count; })
    .slice(0, 6);

  var pEl = document.getElementById('sm-patterns');
  if (pEl) {
    if (!sorted.length) {
      pEl.innerHTML = '<div class="sm-pattern-row"><span style="color:var(--muted)">No patterns yet</span></div>';
    } else {
      pEl.innerHTML = sorted.map(function(p) {
        var label = PATTERN_LABELS[p.type] || p.type.replace(/_/g,' ');
        var active = p.count > 0 ? ' active' : '';
        return '<div class="sm-pattern-row' + active + '">' +
          '<span>' + label + '</span>' +
          '<span class="sm-pattern-count">' + p.count + '</span>' +
          '</div>';
      }).join('');
    }
  }

  // Accumulation bar (0-3 threshold)
  var barEl = document.getElementById('sm-acc-bar');
  var lblEl = document.getElementById('sm-acc-label');
  if (barEl) barEl.style.width = Math.min(100, Math.round((acc / 3) * 100)) + '%';
  if (lblEl) lblEl.textContent = 'Accumulation: ' + acc + ' / 3';

  // If mobile drawer is open, refresh it too
  var drawer = document.getElementById('mobile-drawer');
  if (drawer && drawer.classList.contains('open')) { populateMobileDrawer(); }
}

// Call after every runAnalysis and silentAnalyze
var _origRunAnalysis = typeof runAnalysis === 'function' ? runAnalysis : null;

// ============================================================
// MOBILE DRAWER — Session Memory accessible on small screens
// ============================================================
function openMobileDrawer() {
  populateMobileDrawer();
  document.getElementById('mobile-drawer').classList.add('open');
}
function closeMobileDrawer() {
  document.getElementById('mobile-drawer').classList.remove('open');
}
function populateMobileDrawer() {
  var log = state.log || [];
  var total = log.length;
  var harmsCount = log.filter(function(e){ return (e.detection&&e.detection.count>0)||(e.racialHarms&&e.racialHarms.length>0); }).length;
  var cleanCount = total - harmsCount;
  var level = computeSessionThreshold(log);
  var thresholdColors = { none:'var(--muted)', present:'var(--warn)', elevated:'var(--harm)', escalated:'#dd2244' };
  var thresholdLabels = { none:'None', present:'Present', elevated:'Elevated', escalated:'Escalated' };
  var html = '';
  // Threshold
  html += '<div style="margin-bottom:12px; padding:8px 10px; background:var(--bg3); border-radius:4px; border-left:3px solid '+(thresholdColors[level]||'var(--muted)')+'">';
  html += '<div style="font-size:9px; letter-spacing:2px; color:var(--muted); margin-bottom:4px">THRESHOLD</div>';
  html += '<div style="font-size:13px; font-weight:bold; color:'+(thresholdColors[level]||'var(--muted)')+'">'+(thresholdLabels[level]||level)+'</div>';
  html += '</div>';
  // Stats grid
  html += '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:12px">';
  html += '<div style="text-align:center; padding:8px; background:var(--bg3); border-radius:4px"><div style="font-size:16px; font-weight:bold; color:var(--cream)">'+total+'</div><div style="font-size:9px; color:var(--muted)">Total</div></div>';
  html += '<div style="text-align:center; padding:8px; background:var(--bg3); border-radius:4px"><div style="font-size:16px; font-weight:bold; color:'+(harmsCount>0?'var(--harm)':'var(--muted)')+'">'+harmsCount+'</div><div style="font-size:9px; color:var(--muted)">Harms</div></div>';
  html += '<div style="text-align:center; padding:8px; background:var(--bg3); border-radius:4px"><div style="font-size:16px; font-weight:bold; color:'+(cleanCount>0?'var(--clean)':'var(--muted)')+'">'+cleanCount+'</div><div style="font-size:9px; color:var(--muted)">Clean</div></div>';
  html += '</div>';
  // Export/Clear buttons
  html += '<div style="display:flex; gap:8px; margin-bottom:12px">';
  html += '<button class="btn btn-lavender btn-sm" style="flex:1" onclick="exportSessionLog()">Export Log</button>';
  html += '<button class="btn btn-sm" style="flex:1; color:var(--muted); border-color:var(--border)" onclick="if(confirm(\x27Clear all stored history?\x27)){clearHistory();closeMobileDrawer();}">Clear</button>';
  html += '</div>';
  // Recent entries
  if (log.length > 0) {
    html += '<div style="font-size:9px; letter-spacing:2px; color:var(--muted); margin-bottom:6px">RECENT EXCHANGES</div>';
    var recent = log.slice(-5).reverse();
    recent.forEach(function(e) {
      var hasHarm = (e.detection&&e.detection.count>0)||(e.racialHarms&&e.racialHarms.length>0);
      html += '<div style="padding:7px 10px; margin-bottom:6px; background:var(--bg3); border-left:3px solid '+(hasHarm?'var(--harm)':'var(--clean)')+'; font-size:10px">';
      html += '<div style="color:var(--muted); font-size:9px">'+new Date(e.timestamp).toLocaleTimeString()+'</div>';
      html += '<div style="color:var(--cream); margin-top:2px">'+escHtml((e.userInput||'').substring(0,60))+(e.userInput&&e.userInput.length>60?'...':'')+'</div>';
      html += '<div style="margin-top:3px; color:'+(hasHarm?'var(--harm)':'var(--clean)')+'">'+(hasHarm?'Harm detected':'Clean')+'</div>';
      html += '</div>';
    });
  }
  document.getElementById('mobile-drawer-content').innerHTML = html;
}

initApp();
</script>

<!-- PDF.js and Mammoth.js loaded on demand -->
<script>
// ============================================================
// IMPORT TAB — PDF / DOCX / TXT / HTML / PASTE
// ============================================================

var importExchanges = []; // [{human:'', ai:'', analyzed:false}]
var pdfLibLoaded = false;
var mammothLibLoaded = false;

// ---- Drag & Drop ----
function importDragOver(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.add('drag-over');
}
function importDragLeave(e) {
  document.getElementById('import-dropzone').classList.remove('drag-over');
}
function importDrop(e) {
  e.preventDefault();
  document.getElementById('import-dropzone').classList.remove('drag-over');
  var files = e.dataTransfer.files;
  if (files && files.length) processImportFile(files[0]);
}
function importFileSelected(e) {
  var file = e.target.files && e.target.files[0];
  if (file) processImportFile(file);
}

// ---- Route by file type ----
function processImportFile(file) {
  var name = file.name.toLowerCase();
  showImportProgress('Reading file: ' + file.name, 10);
  if (name.endsWith('.pdf')) {
    loadPdfLib(function(){ extractPdf(file); });
  } else if (name.endsWith('.docx')) {
    loadMammothLib(function(){ extractDocx(file); });
  } else if (name.endsWith('.txt') || name.endsWith('.html') || name.endsWith('.htm')) {
    var reader = new FileReader();
    reader.onload = function(ev) {
      var raw = ev.target.result;
      if (name.endsWith('.html') || name.endsWith('.htm')) {
        var div = document.createElement('div');
        div.innerHTML = raw;
        raw = div.innerText || div.textContent || raw;
      }
      updateImportProgress(60, 'Splitting into exchanges...');
      setTimeout(function(){ finishImport(raw); }, 80);
    };
    reader.readAsText(file);
  } else {
    hideImportProgress();
    alert('Unsupported file type. Please use PDF, DOCX, TXT, or HTML.');
  }
}

// ---- Lazy-load PDF.js ----
function loadPdfLib(cb) {
  if (pdfLibLoaded) { cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
  s.onload = function() {
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    pdfLibLoaded = true;
    cb();
  };
  s.onerror = function() { alert('Could not load PDF library. Check your connection.'); hideImportProgress(); };
  document.head.appendChild(s);
}

// ---- Extract PDF text ----
function extractPdf(file) {
  updateImportProgress(25, 'Loading PDF...');
  var reader = new FileReader();
  reader.onload = function(ev) {
    var typedArray = new Uint8Array(ev.target.result);
    pdfjsLib.getDocument({ data: typedArray }).promise.then(function(pdf) {
      var pageTexts = [];
      var total = pdf.numPages;
      var done = 0;
      for (var i = 1; i <= total; i++) {
        (function(pageNum) {
          pdf.getPage(pageNum).then(function(page) {
            page.getTextContent().then(function(tc) {
              pageTexts[pageNum - 1] = tc.items.map(function(s){ return s.str; }).join(' ');
              done++;
              updateImportProgress(25 + Math.round((done/total)*35), 'Reading page ' + done + ' of ' + total);
              if (done === total) {
                updateImportProgress(65, 'Splitting into exchanges...');
                setTimeout(function(){ finishImport(pageTexts.join('\n')); }, 80);
              }
            });
          });
        })(i);
      }
    }).catch(function(err) {
      hideImportProgress();
      alert('PDF read error: ' + err.message);
    });
  };
  reader.readAsArrayBuffer(file);
}

// ---- Lazy-load Mammoth ----
function loadMammothLib(cb) {
  if (mammothLibLoaded) { cb(); return; }
  var s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js';
  s.onload = function() { mammothLibLoaded = true; cb(); };
  s.onerror = function() { alert('Could not load DOCX library. Check your connection.'); hideImportProgress(); };
  document.head.appendChild(s);
}

// ---- Extract DOCX text ----
function extractDocx(file) {
  updateImportProgress(25, 'Reading Word document...');
  var reader = new FileReader();
  reader.onload = function(ev) {
    mammoth.extractRawText({ arrayBuffer: ev.target.result }).then(function(result) {
      updateImportProgress(65, 'Splitting into exchanges...');
      setTimeout(function(){ finishImport(result.value); }, 80);
    }).catch(function(err) {
      hideImportProgress();
      alert('DOCX read error: ' + err.message);
    });
  };
  reader.readAsArrayBuffer(file);
}

// ---- Paste handler ----
function importFromPaste() {
  var text = document.getElementById('import-paste').value.trim();
  if (!text) { alert('Please paste a conversation first.'); return; }
  showImportProgress('Parsing conversation...', 30);
  setTimeout(function(){ finishImport(text); }, 80);
}

// ---- Core splitter ----
function finishImport(rawText) {
  updateImportProgress(80, 'Detecting speaker turns...');
  var exchanges = splitIntoExchanges(rawText);
  updateImportProgress(100, 'Done — ' + exchanges.length + ' exchanges found');
  setTimeout(function(){
    hideImportProgress();
    if (!exchanges.length) {
      alert('No exchanges detected. The tool looks for patterns like "You:", "Human:", "User:", "Claude:", "ChatGPT:", "AI:", "Assistant:". Make sure the conversation has speaker labels.');
      return;
    }
    importExchanges = exchanges.map(function(ex) {
      return { human: ex.human, ai: ex.ai, analyzed: false };
    });
    renderImportPreview();
  }, 400);
}

// ---- Speaker detection / splitting ----
function splitIntoExchanges(text) {
  // Normalize line endings
  text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

  // Speaker label patterns (case-insensitive)
  var humanLabels = ['You', 'Human', 'User', 'Me', 'Anna', 'Person'];
  var aiLabels = ['Claude', 'ChatGPT', 'GPT', 'AI', 'Assistant', 'Bot', 'System'];

  var allLabels = humanLabels.concat(aiLabels);
  // Build regex: "Label:" or "[Label]" or "**Label**" at line start
  var labelPattern = new RegExp(
    '^(' + allLabels.map(function(l){ return escRe(l); }).join('|') + ')\\s*[:\\]\\*]',
    'im'
  );

  // Check if text has any speaker labels at all
  if (!labelPattern.test(text)) {
    // Fallback: split on blank lines into chunks, treat alternating as human/ai
    return blankLineSplit(text);
  }

  // Line-by-line speaker split
  var lines = text.split('\n');
  var segments = []; // [{speaker:'human'|'ai', text:''}]
  var currentSpeaker = null;
  var currentLines = [];

  var humanRe = new RegExp('^(' + humanLabels.map(escRe).join('|') + ')\\s*[:\\]\\*]+\\s*', 'i');
  var aiRe    = new RegExp('^(' + aiLabels.map(escRe).join('|') + ')\\s*[:\\]\\*]+\\s*', 'i');

  lines.forEach(function(line) {
    var hm = humanRe.exec(line);
    var am = aiRe.exec(line);
    if (hm) {
      if (currentSpeaker) segments.push({ speaker: currentSpeaker, text: currentLines.join('\n').trim() });
      currentSpeaker = 'human';
      currentLines = [line.replace(humanRe, '').trim()];
    } else if (am) {
      if (currentSpeaker) segments.push({ speaker: currentSpeaker, text: currentLines.join('\n').trim() });
      currentSpeaker = 'ai';
      currentLines = [line.replace(aiRe, '').trim()];
    } else {
      if (currentSpeaker) currentLines.push(line);
    }
  });
  if (currentSpeaker && currentLines.length) {
    segments.push({ speaker: currentSpeaker, text: currentLines.join('\n').trim() });
  }

  // Pair up human→ai
  return pairSegments(segments);
}

function escRe(s) {
  return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function pairSegments(segments) {
  var pairs = [];
  var pendingHuman = null;
  segments.forEach(function(seg) {
    if (!seg.text) return;
    if (seg.speaker === 'human') {
      if (pendingHuman) pairs.push({ human: pendingHuman, ai: '[No AI response detected]' });
      pendingHuman = seg.text;
    } else if (seg.speaker === 'ai') {
      if (pendingHuman) {
        pairs.push({ human: pendingHuman, ai: seg.text });
        pendingHuman = null;
      } else {
        pairs.push({ human: '[No human message detected]', ai: seg.text });
      }
    }
  });
  if (pendingHuman) pairs.push({ human: pendingHuman, ai: '[No AI response detected]' });
  return pairs;
}

function blankLineSplit(text) {
  // No labels found — split on double newlines, alternate human/ai
  var chunks = text.split(/\n{2,}/).map(function(c){ return c.trim(); }).filter(Boolean);
  var pairs = [];
  for (var i = 0; i < chunks.length - 1; i += 2) {
    pairs.push({ human: chunks[i], ai: chunks[i+1] || '[No AI response]' });
  }
  return pairs;
}

// ---- Render preview list ----
function renderImportPreview() {
  var area = document.getElementById('import-preview-area');
  var list = document.getElementById('import-exchange-list');
  var title = document.getElementById('import-preview-title');
  title.textContent = importExchanges.length + ' EXCHANGES FOUND';
  list.innerHTML = '';
  importExchanges.forEach(function(ex, i) {
    var card = document.createElement('div');
    card.className = 'import-exchange-card';
    card.id = 'import-card-' + i;
    var preview = ex.human.replace(/\n/g,' ').substring(0, 80);
    card.innerHTML =
      '<div class="import-exchange-header" onclick="toggleImportCard(' + i + ')">' +
        '<span class="import-exchange-num">#' + (i+1) + '</span>' +
        '<span class="import-exchange-preview">' + esc(preview) + '</span>' +
        '<span class="import-analyze-badge" id="badge-' + i + '"></span>' +
        '<button class="btn btn-lavender btn-sm" style="font-size:9px;padding:3px 9px" ' +
          'onclick="event.stopPropagation(); analyzeSingleImport(' + i + ')">Analyze</button>' +
      '</div>' +
      '<div class="import-exchange-body" id="import-body-' + i + '">' +
        '<div class="import-exchange-label">Human</div>' +
        '<div class="import-exchange-text">' + esc(ex.human) + '</div>' +
        '<div class="import-exchange-label">AI</div>' +
        '<div class="import-exchange-text">' + esc(ex.ai) + '</div>' +
      '</div>';
    list.appendChild(card);
  });
  area.style.display = 'block';
}

function esc(s) {
  return (s||'').replace(/&/g,'&#38;').replace(/</g,'&#60;').replace(/>/g,'&#62;');
}

function toggleImportCard(i) {
  var body = document.getElementById('import-body-' + i);
  body.classList.toggle('open');
}

// ---- Analyze single exchange ----
function analyzeSingleImport(i) {
  var ex = importExchanges[i];
  // Populate the analyze tab fields and run analysis
  document.getElementById('human-input').value = ex.human;
  document.getElementById('ai-output').value = ex.ai;
  switchTab('analyze');
  setTimeout(function(){ runAnalysis(); }, 120);
  // Mark as analyzed
  importExchanges[i].analyzed = true;
  var badge = document.getElementById('badge-' + i);
  if (badge) badge.innerHTML = '<span class="import-analyzed-badge">ANALYZED</span>';
}

// ---- Analyze ALL sequentially ----
function analyzeAllImported() {
  if (!importExchanges.length) return;
  showImportProgress('Analyzing ' + importExchanges.length + ' exchanges...', 5);
  var i = 0;
  function next() {
    if (i >= importExchanges.length) {
      updateImportProgress(100, 'All exchanges analyzed and logged.');
      setTimeout(function(){
        hideImportProgress();
        switchTab('audit');
      }, 800);
      return;
    }
    var pct = Math.round((i / importExchanges.length) * 90) + 5;
    updateImportProgress(pct, 'Analyzing exchange ' + (i+1) + ' of ' + importExchanges.length + '...');
    var ex = importExchanges[i];
    // Silently log without switching tabs — call analysis logic directly
    silentAnalyze(ex.human, ex.ai, function() {
      importExchanges[i].analyzed = true;
      var badge = document.getElementById('badge-' + i);
      if (badge) badge.innerHTML = '<span class="import-analyzed-badge">ANALYZED</span>';
      i++;
      setTimeout(next, 60);
    });
  }
  next();
}

// ---- Silent analysis (no UI switch, just logs) ----
function silentAnalyze(humanText, aiText, cb) {
  if (!humanText.trim() && !aiText.trim()) { cb(); return; }
  var det = detect(aiText);
  var racial = detectRacial(humanText + ' ' + aiText);
  var sev = calculateSeverity(det, racial);
  var ts = new Date().toISOString();
  var id = 'entry_' + Date.now() + '_' + Math.random().toString(36).slice(2,6);
  var entry = {
    id: id,
    timestamp: ts,
    human: humanText.trim().substring(0,500),
    ai: aiText.trim().substring(0,500),
    detection: det,
    racialHarms: racial,
    severity: sev,
    annotation: '',
    tags: [],
    hash: simpleHash(humanText + aiText + ts)
  };
  state.log.unshift(entry);
  persistState();
  updateSidebar();
  // Upgrade to SHA-256 async
  Promise.all([sha256(humanText), sha256(aiText), sha256(humanText+aiText+ts)])
    .then(function(hashes) {
      entry.input_sha256 = hashes[0];
      entry.output_sha256 = hashes[1];
      entry.combo_sha256 = hashes[2];
      entry.hash = hashes[2];
      persistState();
    }).catch(function(){});
  cb();
}

// ---- Progress helpers ----
function showImportProgress(label, pct) {
  var el = document.getElementById('import-progress');
  el.style.display = 'block';
  document.getElementById('import-progress-label').textContent = label;
  document.getElementById('import-progress-bar').style.width = pct + '%';
  document.getElementById('import-progress-text').textContent = pct + '%';
}
function updateImportProgress(pct, text) {
  document.getElementById('import-progress-bar').style.width = pct + '%';
  document.getElementById('import-progress-text').textContent = text || (pct + '%');
}
function hideImportProgress() {
  document.getElementById('import-progress').style.display = 'none';
}

// ---- Clear ----
function clearImport() {
  importExchanges = [];
  document.getElementById('import-paste').value = '';
  document.getElementById('import-preview-area').style.display = 'none';
  document.getElementById('import-exchange-list').innerHTML = '';
  document.getElementById('import-file-input').value = '';
  hideImportProgress();
}
</script>
</body>
</html>
